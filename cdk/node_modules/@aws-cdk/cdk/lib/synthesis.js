"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cxapi = require("@aws-cdk/cx-api");
const fs = require("fs");
const os = require("os");
const path = require("path");
const runtime_info_1 = require("./runtime-info");
class SynthesisSession {
    constructor(options) {
        this.artifacts = {};
        this.buildSteps = {};
        this.store = options.store;
        this.legacyManifest = options.legacyManifest !== undefined ? options.legacyManifest : false;
        this.runtimeInfo = options.runtimeInformation !== undefined ? options.runtimeInformation : true;
    }
    /**
     * @returns true if `obj` implements `ISynthesizable`.
     */
    static isSynthesizable(obj) {
        return 'synthesize' in obj;
    }
    get manifest() {
        if (!this._manifest) {
            throw new Error(`Cannot read assembly manifest before the session has been finalized`);
        }
        return this._manifest;
    }
    addArtifact(id, artifact) {
        cxapi.validateArtifact(artifact);
        this.artifacts[id] = artifact;
    }
    tryGetArtifact(id) {
        return this.artifacts[id];
    }
    addBuildStep(id, step) {
        if (id in this.buildSteps) {
            throw new Error(`Build step ${id} already exists`);
        }
        this.buildSteps[id] = step;
    }
    close() {
        const manifest = this._manifest = {
            version: cxapi.PROTO_RESPONSE_VERSION,
            artifacts: this.artifacts,
        };
        if (this.runtimeInfo) {
            manifest.runtime = runtime_info_1.collectRuntimeInformation();
        }
        this.store.writeFile(cxapi.MANIFEST_FILE, JSON.stringify(manifest, undefined, 2));
        // write build manifest if we have build steps
        if (Object.keys(this.buildSteps).length > 0) {
            const buildManifest = {
                steps: this.buildSteps
            };
            this.store.writeFile(cxapi.BUILD_FILE, JSON.stringify(buildManifest, undefined, 2));
        }
        if (this.legacyManifest) {
            const legacy = Object.assign({}, manifest, { stacks: renderLegacyStacks(this.artifacts, this.store) });
            // render the legacy manifest (cdk.out) which also contains a "stacks" attribute with all the rendered stacks.
            this.store.writeFile(cxapi.OUTFILE_NAME, JSON.stringify(legacy, undefined, 2));
        }
        return manifest;
    }
}
exports.SynthesisSession = SynthesisSession;
/**
 * Can be used to prepare and emit synthesis artifacts into an output directory.
 */
class FileSystemStore {
    constructor(options) {
        this.locked = false;
        this.outdir = options.outdir;
        return;
    }
    writeFile(fileName, data) {
        this.canWrite(fileName);
        const p = this.pathForArtifact(fileName);
        fs.writeFileSync(p, data);
    }
    writeJson(fileName, json) {
        this.writeFile(fileName, JSON.stringify(json, undefined, 2));
    }
    readFile(fileName) {
        const p = this.pathForArtifact(fileName);
        if (!fs.existsSync(p)) {
            throw new Error(`File not found: ${p}`);
        }
        return fs.readFileSync(p);
    }
    readJson(fileName) {
        return JSON.parse(this.readFile(fileName).toString());
    }
    exists(name) {
        const p = this.pathForArtifact(name);
        return fs.existsSync(p);
    }
    mkdir(directoryName) {
        this.canWrite(directoryName);
        const p = this.pathForArtifact(directoryName);
        fs.mkdirSync(p);
        return p;
    }
    readdir(directoryName) {
        if (!this.exists(directoryName)) {
            throw new Error(`${directoryName} not found`);
        }
        const p = this.pathForArtifact(directoryName);
        return fs.readdirSync(p);
    }
    list() {
        return fs.readdirSync(this.outdir).sort();
    }
    finalize() {
        this.locked = true;
    }
    pathForArtifact(id) {
        return path.join(this.outdir, id);
    }
    canWrite(artifactName) {
        if (this.exists(artifactName)) {
            throw new Error(`An artifact named ${artifactName} was already written to this session`);
        }
        if (this.locked) {
            throw new Error('Session has already been finalized');
        }
    }
}
exports.FileSystemStore = FileSystemStore;
class InMemoryStore {
    constructor() {
        this.files = {};
        this.dirs = {}; // value is path to a temporary directory
        this.locked = false;
    }
    writeFile(fileName, data) {
        this.canWrite(fileName);
        this.files[fileName] = data;
    }
    writeJson(fileName, json) {
        this.writeFile(fileName, JSON.stringify(json, undefined, 2));
    }
    readFile(fileName) {
        if (!(fileName in this.files)) {
            throw new Error(`${fileName} not found`);
        }
        return this.files[fileName];
    }
    readJson(fileName) {
        return JSON.parse(this.readFile(fileName).toString());
    }
    exists(name) {
        return name in this.files || name in this.dirs;
    }
    mkdir(directoryName) {
        this.canWrite(directoryName);
        const p = fs.mkdtempSync(path.join(os.tmpdir(), directoryName));
        this.dirs[directoryName] = p;
        return p;
    }
    readdir(directoryName) {
        if (!this.exists(directoryName)) {
            throw new Error(`${directoryName} not found`);
        }
        const p = this.dirs[directoryName];
        return fs.readdirSync(p);
    }
    list() {
        return [...Object.keys(this.files), ...Object.keys(this.dirs)].sort();
    }
    finalize() {
        this.locked = true;
    }
    canWrite(artifactName) {
        if (this.exists(artifactName)) {
            throw new Error(`An artifact named ${artifactName} was already written to this session`);
        }
        if (this.locked) {
            throw new Error('Session has already been finalized');
        }
    }
}
exports.InMemoryStore = InMemoryStore;
function renderLegacyStacks(artifacts, store) {
    // special case for backwards compat. build a list of stacks for the manifest
    const stacks = new Array();
    for (const [id, artifact] of Object.entries(artifacts)) {
        if (artifact.type === cxapi.ArtifactType.AwsCloudFormationStack) {
            const templateFile = artifact.properties && artifact.properties.templateFile;
            if (!templateFile) {
                throw new Error(`Invalid cloudformation artifact. Missing "template" property`);
            }
            const template = store.readJson(templateFile);
            const match = cxapi.AWS_ENV_REGEX.exec(artifact.environment);
            if (!match) {
                throw new Error(`"environment" must match regex: ${cxapi.AWS_ENV_REGEX}`);
            }
            const synthStack = {
                name: id,
                environment: { name: artifact.environment.substr('aws://'.length), account: match[1], region: match[2] },
                template,
                metadata: artifact.metadata || {},
            };
            if (artifact.dependencies && artifact.dependencies.length > 0) {
                synthStack.dependsOn = artifact.dependencies;
            }
            if (artifact.missing) {
                synthStack.missing = artifact.missing;
            }
            stacks.push(synthStack);
        }
    }
    return stacks;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ludGhlc2lzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic3ludGhlc2lzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEseUNBQTBDO0FBQzFDLHlCQUEwQjtBQUMxQix5QkFBMEI7QUFDMUIsNkJBQThCO0FBQzlCLGlEQUEyRDtBQWlDM0QsTUFBYSxnQkFBZ0I7SUFnQjNCLFlBQVksT0FBZ0M7UUFOM0IsY0FBUyxHQUFxQyxFQUFHLENBQUM7UUFDbEQsZUFBVSxHQUFzQyxFQUFHLENBQUM7UUFNbkUsSUFBSSxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDO1FBQzNCLElBQUksQ0FBQyxjQUFjLEdBQUcsT0FBTyxDQUFDLGNBQWMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztRQUM1RixJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQ2xHLENBQUM7SUFuQkQ7O09BRUc7SUFDSSxNQUFNLENBQUMsZUFBZSxDQUFDLEdBQVE7UUFDcEMsT0FBTyxZQUFZLElBQUksR0FBRyxDQUFDO0lBQzdCLENBQUM7SUFnQkQsSUFBVyxRQUFRO1FBQ2pCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ25CLE1BQU0sSUFBSSxLQUFLLENBQUMscUVBQXFFLENBQUMsQ0FBQztTQUN4RjtRQUVELE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUN4QixDQUFDO0lBRU0sV0FBVyxDQUFDLEVBQVUsRUFBRSxRQUF3QjtRQUNyRCxLQUFLLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDakMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsR0FBRyxRQUFRLENBQUM7SUFDaEMsQ0FBQztJQUVNLGNB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RUQsTUFBTSxVQUFVLEdBQTJCO2dCQUN6QyxJQUFJLEVBQUUsRUFBRTtnQkFDUixXQUFXLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRTtnQkFDeEcsUUFBUTtnQkFDUixRQUFRLEVBQUUsUUFBUSxDQUFDLFFBQVEsSUFBSSxFQUFFO2FBQ2xDLENBQUM7WUFFRixJQUFJLFFBQVEsQ0FBQyxZQUFZLElBQUksUUFBUSxDQUFDLFlBQVksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUM3RCxVQUFVLENBQUMsU0FBUyxHQUFHLFFBQVEsQ0FBQyxZQUFZLENBQUM7YUFDOUM7WUFFRCxJQUFJLFFBQVEsQ0FBQyxPQUFPLEVBQUU7Z0JBQ3BCLFVBQVUsQ0FBQyxPQUFPLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQzthQUN2QztZQUVELE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDekI7S0FDRjtJQUVELE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY3hhcGkgPSByZXF1aXJlKCdAYXdzLWNkay9jeC1hcGknKTtcbmltcG9ydCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG5pbXBvcnQgb3MgPSByZXF1aXJlKCdvcycpO1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5pbXBvcnQgeyBjb2xsZWN0UnVudGltZUluZm9ybWF0aW9uIH0gZnJvbSAnLi9ydW50aW1lLWluZm8nO1xuXG5leHBvcnQgaW50ZXJmYWNlIElTeW50aGVzaXphYmxlIHtcbiAgc3ludGhlc2l6ZShzZXNzaW9uOiBJU3ludGhlc2lzU2Vzc2lvbik6IHZvaWQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVN5bnRoZXNpc1Nlc3Npb24ge1xuICByZWFkb25seSBzdG9yZTogSVNlc3Npb25TdG9yZTtcbiAgcmVhZG9ubHkgbWFuaWZlc3Q6IGN4YXBpLkFzc2VtYmx5TWFuaWZlc3Q7XG4gIGFkZEFydGlmYWN0KGlkOiBzdHJpbmcsIGRyb3BsZXQ6IGN4YXBpLkFydGlmYWN0KTogdm9pZDtcbiAgYWRkQnVpbGRTdGVwKGlkOiBzdHJpbmcsIHN0ZXA6IGN4YXBpLkJ1aWxkU3RlcCk6IHZvaWQ7XG4gIHRyeUdldEFydGlmYWN0KGlkOiBzdHJpbmcpOiBjeGFwaS5BcnRpZmFjdCB8IHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTeW50aGVzaXNTZXNzaW9uT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBUaGUgZmlsZSBzdG9yZSB1c2VkIGZvciB0aGlzIHNlc3Npb24uXG4gICAqL1xuICBzdG9yZTogSVNlc3Npb25TdG9yZTtcblxuICAvKipcbiAgICogRW1pdCB0aGUgbGVnYWN5IG1hbmlmZXN0IChgY2RrLm91dGApIHdoZW4gdGhlIHNlc3Npb24gaXMgY2xvc2VkIChhbG9uZ3NpZGUgYG1hbmlmZXN0Lmpzb25gKS5cbiAgICogQGRlZmF1bHQgZmFsc2VcbiAgICovXG4gIGxlZ2FjeU1hbmlmZXN0PzogYm9vbGVhbjtcblxuICAvKipcbiAgICogSW5jbHVkZSBydW50aW1lIGluZm9ybWF0aW9uIChtb2R1bGUgdmVyc2lvbnMpIGluIG1hbmlmZXN0LlxuICAgKiBAZGVmYXVsdCB0cnVlXG4gICAqL1xuICBydW50aW1lSW5mb3JtYXRpb24/OiBib29sZWFuO1xufVxuXG5leHBvcnQgY2xhc3MgU3ludGhlc2lzU2Vzc2lvbiBpbXBsZW1lbnRzIElTeW50aGVzaXNTZXNzaW9uIHtcbiAgLyoqXG4gICAqIEByZXR1cm5zIHRydWUgaWYgYG9iamAgaW1wbGVtZW50cyBgSVN5bnRoZXNpemFibGVgLlxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBpc1N5bnRoZXNpemFibGUob2JqOiBhbnkpOiBvYmogaXMgSVN5bnRoZXNpemFibGUge1xuICAgIHJldHVybiAnc3ludGhlc2l6ZScgaW4gb2JqO1xuICB9XG5cbiAgcHVibGljIHJlYWRvbmx5IHN0b3JlOiBJU2Vzc2lvblN0b3JlO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgYXJ0aWZhY3RzOiB7IFtpZDogc3RyaW5nXTogY3hhcGkuQXJ0aWZhY3QgfSA9IHsgfTtcbiAgcHJpdmF0ZSByZWFkb25seSBidWlsZFN0ZXBzOiB7IFtpZDogc3RyaW5nXTogY3hhcGkuQnVpbGRTdGVwIH0gPSB7IH07XG4gIHByaXZhdGUgX21hbmlmZXN0PzogY3hhcGkuQXNzZW1ibHlNYW5pZmVzdDtcbiAgcHJpdmF0ZSByZWFkb25seSBsZWdhY3lNYW5pZmVzdDogYm9vbGVhbjtcbiAgcHJpdmF0ZSByZWFkb25seSBydW50aW1lSW5mbzogYm9vbGVhbjtcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBTeW50aGVzaXNTZXNzaW9uT3B0aW9ucykge1xuICAgIHRoaXMuc3RvcmUgPSBvcHRpb25zLnN0b3JlO1xuICAgIHRoaXMubGVnYWN5TWFuaWZlc3QgPSBvcHRpb25zLmxlZ2FjeU1hbmlmZXN0ICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmxlZ2FjeU1hbmlmZXN0IDogZmFsc2U7XG4gICAgdGhpcy5ydW50aW1lSW5mbyA9IG9wdGlvbnMucnVudGltZUluZm9ybWF0aW9uICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnJ1bnRpbWVJbmZvcm1hdGlvbiA6IHRydWU7XG4gIH1cblxuICBwdWJsaWMgZ2V0IG1hbmlmZXN0KCkge1xuICAgIGlmICghdGhpcy5fbWFuaWZlc3QpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHJlYWQgYXNzZW1ibHkgbWFuaWZlc3QgYmVmb3JlIHRoZSBzZXNzaW9uIGhhcyBiZWVuIGZpbmFsaXplZGApO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLl9tYW5pZmVzdDtcbiAgfVxuXG4gIHB1YmxpYyBhZGRBcnRpZmFjdChpZDogc3RyaW5nLCBhcnRpZmFjdDogY3hhcGkuQXJ0aWZhY3QpOiB2b2lkIHtcbiAgICBjeGFwaS52YWxpZGF0ZUFydGlmYWN0KGFydGlmYWN0KTtcbiAgICB0aGlzLmFydGlmYWN0c1tpZF0gPSBhcnRpZmFjdDtcbiAgfVxuXG4gIHB1YmxpYyB0cnlHZXRBcnRpZmFjdChpZDogc3RyaW5nKTogY3hhcGkuQXJ0aWZhY3QgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLmFydGlmYWN0c1tpZF07XG4gIH1cblxuICBwdWJsaWMgYWRkQnVpbGRTdGVwKGlkOiBzdHJpbmcsIHN0ZXA6IGN4YXBpLkJ1aWxkU3RlcCkge1xuICAgIGlmIChpZCBpbiB0aGlzLmJ1aWxkU3RlcHMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQnVpbGQgc3RlcCAke2lkfSBhbHJlYWR5IGV4aXN0c2ApO1xuICAgIH1cbiAgICB0aGlzLmJ1aWxkU3RlcHNbaWRdID0gc3RlcDtcbiAgfVxuXG4gIHB1YmxpYyBjbG9zZSgpOiBjeGFwaS5Bc3NlbWJseU1hbmlmZXN0IHtcbiAgICBjb25zdCBtYW5pZmVzdDogY3hhcGkuQXNzZW1ibHlNYW5pZmVzdCA9IHRoaXMuX21hbmlmZXN0ID0ge1xuICAgICAgdmVyc2lvbjogY3hhcGkuUFJPVE9fUkVTUE9OU0VfVkVSU0lPTixcbiAgICAgIGFydGlmYWN0czogdGhpcy5hcnRpZmFjdHMsXG4gICAgfTtcblxuICAgIGlmICh0aGlzLnJ1bnRpbWVJbmZvKSB7XG4gICAgICBtYW5pZmVzdC5ydW50aW1lID0gY29sbGVjdFJ1bnRpbWVJbmZvcm1hdGlvbigpO1xuICAgIH1cblxuICAgIHRoaXMuc3RvcmUud3JpdGVGaWxlKGN4YXBpLk1BTklGRVNUX0ZJTEUsIEpTT04uc3RyaW5naWZ5KG1hbmlmZXN0LCB1bmRlZmluZWQsIDIpKTtcblxuICAgIC8vIHdyaXRlIGJ1aWxkIG1hbmlmZXN0IGlmIHdlIGhhdmUgYnVpbGQgc3RlcHNcbiAgICBpZiAoT2JqZWN0LmtleXModGhpcy5idWlsZFN0ZXBzKS5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBidWlsZE1hbmlmZXN0OiBjeGFwaS5CdWlsZE1hbmlmZXN0ID0ge1xuICAgICAgICBzdGVwczogdGhpcy5idWlsZFN0ZXBzXG4gICAgICB9O1xuXG4gICAgICB0aGlzLnN0b3JlLndyaXRlRmlsZShjeGFwaS5CVUlMRF9GSUxFLCBKU09OLnN0cmluZ2lmeShidWlsZE1hbmlmZXN0LCB1bmRlZmluZWQsIDIpKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5sZWdhY3lNYW5pZmVzdCkge1xuICAgICAgY29uc3QgbGVnYWN5OiBjeGFwaS5TeW50aGVzaXplUmVzcG9uc2UgPSB7XG4gICAgICAgIC4uLm1hbmlmZXN0LFxuICAgICAgICBzdGFja3M6IHJlbmRlckxlZ2FjeVN0YWNrcyh0aGlzLmFydGlmYWN0cywgdGhpcy5zdG9yZSlcbiAgICAgIH07XG5cbiAgICAgIC8vIHJlbmRlciB0aGUgbGVnYWN5IG1hbmlmZXN0IChjZGsub3V0KSB3aGljaCBhbHNvIGNvbnRhaW5zIGEgXCJzdGFja3NcIiBhdHRyaWJ1dGUgd2l0aCBhbGwgdGhlIHJlbmRlcmVkIHN0YWNrcy5cbiAgICAgIHRoaXMuc3RvcmUud3JpdGVGaWxlKGN4YXBpLk9VVEZJTEVfTkFNRSwgSlNPTi5zdHJpbmdpZnkobGVnYWN5LCB1bmRlZmluZWQsIDIpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbWFuaWZlc3Q7XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBJU2Vzc2lvblN0b3JlIHtcbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBkaXJlY3RvcnkgYW5kIHJldHVybnMgaXQncyBmdWxsIHBhdGguXG4gICAqIEBwYXJhbSBkaXJlY3RvcnlOYW1lIFRoZSBuYW1lIG9mIHRoZSBkaXJlY3RvcnkgdG8gY3JlYXRlLlxuICAgKiBAdGhyb3dzIGlmIGEgZGlyZWN0b3J5IGJ5IHRoYXQgbmFtZSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgc2Vzc2lvbiBvciBpZiB0aGUgc2Vzc2lvbiBoYXMgYWxyZWFkeSBiZWVuIGZpbmFsaXplZC5cbiAgICovXG4gIG1rZGlyKGRpcmVjdG9yeU5hbWU6IHN0cmluZyk6IHN0cmluZztcblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgbGlzdCBvZiBmaWxlcyBpbiBhIGRpcmVjdG9yeS5cbiAgICogQHBhcmFtIGRpcmVjdG9yeU5hbWUgVGhlIG5hbWUgb2YgdGhlIGFydGlmYWN0XG4gICAqIEB0aHJvd3MgaWYgdGhlcmUgaXMgbm8gZGlyZWN0b3J5IGFydGlmYWN0IHVuZGVyIHRoaXMgbmFtZVxuICAgKi9cbiAgcmVhZGRpcihkaXJlY3RvcnlOYW1lOiBzdHJpbmcpOiBzdHJpbmdbXTtcblxuICAvKipcbiAgICogV3JpdGVzIGEgZmlsZSBpbnRvIHRoZSBzdG9yZS5cbiAgICogQHBhcmFtIGFydGlmYWN0TmFtZSBUaGUgbmFtZSBvZiB0aGUgZmlsZS5cbiAgICogQHBhcmFtIGRhdGEgVGhlIGNvbnRlbnRzIG9mIHRoZSBmaWxlLlxuICAgKi9cbiAgd3JpdGVGaWxlKGFydGlmYWN0TmFtZTogc3RyaW5nLCBkYXRhOiBhbnkpOiB2b2lkO1xuXG4gIC8qKlxuICAgKiBXcml0ZXMgYSBmb3JtYXR0ZWQgSlNPTiBvdXRwdXQgZmlsZSB0byB0aGUgc3RvcmVcbiAgICogQHBhcmFtIGFydGlmYWN0TmFtZSB0aGUgbmFtZSBvZiB0aGUgYXJ0aWZhY3RcbiAgICogQHBhcmFtIGpzb24gdGhlIEpTT04gb2JqZWN0XG4gICAqL1xuICB3cml0ZUpzb24oYXJ0aWZhY3ROYW1lOiBzdHJpbmcsIGpzb246IGFueSk6IHZvaWQ7XG5cbiAgLyoqXG4gICAqIFJlYWRzIGEgZmlsZSBmcm9tIHRoZSBzdG9yZS5cbiAgICogQHBhcmFtIGZpbGVOYW1lIFRoZSBuYW1lIG9mIHRoZSBmaWxlLlxuICAgKiBAdGhyb3dzIGlmIHRoZSBmaWxlIGlzIG5vdCBmb3VuZFxuICAgKi9cbiAgcmVhZEZpbGUoZmlsZU5hbWU6IHN0cmluZyk6IGFueTtcblxuICAvKipcbiAgICogUmVhZHMgYSBKU09OIG9iamVjdCBmcm9tIHRoZSBzdG9yZS5cbiAgICovXG4gIHJlYWRKc29uKGZpbGVOYW1lOiBzdHJpbmcpOiBhbnk7XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIHRydWUgaWYgdGhlIGZpbGUgYGZpbGVOYW1lYCBleGlzdHMgaW4gdGhlIHN0b3JlLlxuICAgKiBAcGFyYW0gbmFtZSBUaGUgbmFtZSBvZiB0aGUgZmlsZSBvciBkaXJlY3RvcnkgdG8gbG9vayB1cC5cbiAgICovXG4gIGV4aXN0cyhuYW1lOiBzdHJpbmcpOiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBMaXN0IGFsbCB0b3AtbGV2ZWwgZmlsZXMgdGhhdCB3ZXJlIGVtaXR0ZWQgdG8gdGhlIHN0b3JlLlxuICAgKi9cbiAgbGlzdCgpOiBzdHJpbmdbXTtcblxuICAvKipcbiAgICogRG8gbm90IGFsbG93IGZ1cnRoZXIgd3JpdGVzIGludG8gdGhlIHN0b3JlLlxuICAgKi9cbiAgZmluYWxpemUoKTogdm9pZDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTeW50aGVzaXNTZXNzaW9uT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBXaGVyZSB0byBzdG9yZSB0aGVcbiAgICovXG4gIHN0b3JlOiBJU2Vzc2lvblN0b3JlO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEZpbGVTeXN0ZW1TdG9yZU9wdGlvbnMge1xuICAvKipcbiAgICogVGhlIG91dHB1dCBkaXJlY3RvcnkgZm9yIHN5bnRoZXNpcyBhcnRpZmFjdHNcbiAgICovXG4gIG91dGRpcjogc3RyaW5nO1xufVxuXG4vKipcbiAqIENhbiBiZSB1c2VkIHRvIHByZXBhcmUgYW5kIGVtaXQgc3ludGhlc2lzIGFydGlmYWN0cyBpbnRvIGFuIG91dHB1dCBkaXJlY3RvcnkuXG4gKi9cbmV4cG9ydCBjbGFzcyBGaWxlU3lzdGVtU3RvcmUgaW1wbGVtZW50cyBJU2Vzc2lvblN0b3JlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBvdXRkaXI6IHN0cmluZztcbiAgcHJpdmF0ZSBsb2NrZWQgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBGaWxlU3lzdGVtU3RvcmVPcHRpb25zKSB7XG4gICAgdGhpcy5vdXRkaXIgPSBvcHRpb25zLm91dGRpcjtcbiAgICByZXR1cm47XG4gIH1cblxuICBwdWJsaWMgd3JpdGVGaWxlKGZpbGVOYW1lOiBzdHJpbmcsIGRhdGE6IGFueSkge1xuICAgIHRoaXMuY2FuV3JpdGUoZmlsZU5hbWUpO1xuXG4gICAgY29uc3QgcCA9IHRoaXMucGF0aEZvckFydGlmYWN0KGZpbGVOYW1lKTtcbiAgICBmcy53cml0ZUZpbGVTeW5jKHAsIGRhdGEpO1xuICB9XG5cbiAgcHVibGljIHdyaXRlSnNvbihmaWxlTmFtZTogc3RyaW5nLCBqc29uOiBhbnkpIHtcbiAgICB0aGlzLndyaXRlRmlsZShmaWxlTmFtZSwgSlNPTi5zdHJpbmdpZnkoanNvbiwgdW5kZWZpbmVkLCAyKSk7XG4gIH1cblxuICBwdWJsaWMgcmVhZEZpbGUoZmlsZU5hbWU6IHN0cmluZyk6IGFueSB7XG4gICAgY29uc3QgcCA9IHRoaXMucGF0aEZvckFydGlmYWN0KGZpbGVOYW1lKTtcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMocCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmlsZSBub3QgZm91bmQ6ICR7cH1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZnMucmVhZEZpbGVTeW5jKHApO1xuICB9XG5cbiAgcHVibGljIHJlYWRKc29uKGZpbGVOYW1lOiBzdHJpbmcpOiBhbnkge1xuICAgIHJldHVybiBKU09OLnBhcnNlKHRoaXMucmVhZEZpbGUoZmlsZU5hbWUpLnRvU3RyaW5nKCkpO1xuICB9XG5cbiAgcHVibGljIGV4aXN0cyhuYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBjb25zdCBwID0gdGhpcy5wYXRoRm9yQXJ0aWZhY3QobmFtZSk7XG4gICAgcmV0dXJuIGZzLmV4aXN0c1N5bmMocCk7XG4gIH1cblxuICBwdWJsaWMgbWtkaXIoZGlyZWN0b3J5TmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICB0aGlzLmNhbldyaXRlKGRpcmVjdG9yeU5hbWUpO1xuICAgIGNvbnN0IHAgPSB0aGlzLnBhdGhGb3JBcnRpZmFjdChkaXJlY3RvcnlOYW1lKTtcbiAgICBmcy5ta2RpclN5bmMocCk7XG4gICAgcmV0dXJuIHA7XG4gIH1cblxuICBwdWJsaWMgcmVhZGRpcihkaXJlY3RvcnlOYW1lOiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gICAgaWYgKCF0aGlzLmV4aXN0cyhkaXJlY3RvcnlOYW1lKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAke2RpcmVjdG9yeU5hbWV9IG5vdCBmb3VuZGApO1xuICAgIH1cblxuICAgIGNvbnN0IHAgPSB0aGlzLnBhdGhGb3JBcnRpZmFjdChkaXJlY3RvcnlOYW1lKTtcbiAgICByZXR1cm4gZnMucmVhZGRpclN5bmMocCk7XG4gIH1cblxuICBwdWJsaWMgbGlzdCgpOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIGZzLnJlYWRkaXJTeW5jKHRoaXMub3V0ZGlyKS5zb3J0KCk7XG4gIH1cblxuICBwdWJsaWMgZmluYWxpemUoKSB7XG4gICAgdGhpcy5sb2NrZWQgPSB0cnVlO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXRoRm9yQXJ0aWZhY3QoaWQ6IHN0cmluZykge1xuICAgIHJldHVybiBwYXRoLmpvaW4odGhpcy5vdXRkaXIsIGlkKTtcbiAgfVxuXG4gIHByaXZhdGUgY2FuV3JpdGUoYXJ0aWZhY3ROYW1lOiBzdHJpbmcpIHtcbiAgICBpZiAodGhpcy5leGlzdHMoYXJ0aWZhY3ROYW1lKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBBbiBhcnRpZmFjdCBuYW1lZCAke2FydGlmYWN0TmFtZX0gd2FzIGFscmVhZHkgd3JpdHRlbiB0byB0aGlzIHNlc3Npb25gKTtcbiAgICB9XG4gICAgaWYgKHRoaXMubG9ja2VkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Nlc3Npb24gaGFzIGFscmVhZHkgYmVlbiBmaW5hbGl6ZWQnKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEluTWVtb3J5U3RvcmUgaW1wbGVtZW50cyBJU2Vzc2lvblN0b3JlIHtcbiAgcHJpdmF0ZSBmaWxlczogeyBbZmlsZU5hbWU6IHN0cmluZ106IGFueSB9ID0geyB9O1xuICBwcml2YXRlIGRpcnM6IHsgW2Rpck5hbWU6IHN0cmluZ106IHN0cmluZyB9ID0geyB9OyAvLyB2YWx1ZSBpcyBwYXRoIHRvIGEgdGVtcG9yYXJ5IGRpcmVjdG9yeVxuXG4gIHByaXZhdGUgbG9ja2VkID0gZmFsc2U7XG5cbiAgcHVibGljIHdyaXRlRmlsZShmaWxlTmFtZTogc3RyaW5nLCBkYXRhOiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLmNhbldyaXRlKGZpbGVOYW1lKTtcbiAgICB0aGlzLmZpbGVzW2ZpbGVOYW1lXSA9IGRhdGE7XG4gIH1cblxuICBwdWJsaWMgd3JpdGVKc29uKGZpbGVOYW1lOiBzdHJpbmcsIGpzb246IGFueSk6IHZvaWQge1xuICAgIHRoaXMud3JpdGVGaWxlKGZpbGVOYW1lLCBKU09OLnN0cmluZ2lmeShqc29uLCB1bmRlZmluZWQsIDIpKTtcbiAgfVxuXG4gIHB1YmxpYyByZWFkRmlsZShmaWxlTmFtZTogc3RyaW5nKSB7XG4gICAgaWYgKCEoZmlsZU5hbWUgaW4gdGhpcy5maWxlcykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgJHtmaWxlTmFtZX0gbm90IGZvdW5kYCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmZpbGVzW2ZpbGVOYW1lXTtcbiAgfVxuXG4gIHB1YmxpYyByZWFkSnNvbihmaWxlTmFtZTogc3RyaW5nKTogYW55IHtcbiAgICByZXR1cm4gSlNPTi5wYXJzZSh0aGlzLnJlYWRGaWxlKGZpbGVOYW1lKS50b1N0cmluZygpKTtcbiAgfVxuXG4gIHB1YmxpYyBleGlzdHMobmFtZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIG5hbWUgaW4gdGhpcy5maWxlcyB8fCBuYW1lIGluIHRoaXMuZGlycztcbiAgfVxuXG4gIHB1YmxpYyBta2RpcihkaXJlY3RvcnlOYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHRoaXMuY2FuV3JpdGUoZGlyZWN0b3J5TmFtZSk7XG5cbiAgICBjb25zdCBwID0gZnMubWtkdGVtcFN5bmMocGF0aC5qb2luKG9zLnRtcGRpcigpLCBkaXJlY3RvcnlOYW1lKSk7XG4gICAgdGhpcy5kaXJzW2RpcmVjdG9yeU5hbWVdID0gcDtcbiAgICByZXR1cm4gcDtcbiAgfVxuXG4gIHB1YmxpYyByZWFkZGlyKGRpcmVjdG9yeU5hbWU6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgICBpZiAoIXRoaXMuZXhpc3RzKGRpcmVjdG9yeU5hbWUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7ZGlyZWN0b3J5TmFtZX0gbm90IGZvdW5kYCk7XG4gICAgfVxuXG4gICAgY29uc3QgcCA9IHRoaXMuZGlyc1tkaXJlY3RvcnlOYW1lXTtcbiAgICByZXR1cm4gZnMucmVhZGRpclN5bmMocCk7XG4gIH1cblxuICBwdWJsaWMgbGlzdCgpOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIFsgLi4uT2JqZWN0LmtleXModGhpcy5maWxlcyksIC4uLk9iamVjdC5rZXlzKHRoaXMuZGlycykgXS5zb3J0KCk7XG4gIH1cblxuICBwdWJsaWMgZmluYWxpemUoKSB7XG4gICAgdGhpcy5sb2NrZWQgPSB0cnVlO1xuICB9XG5cbiAgcHJpdmF0ZSBjYW5Xcml0ZShhcnRpZmFjdE5hbWU6IHN0cmluZykge1xuICAgIGlmICh0aGlzLmV4aXN0cyhhcnRpZmFjdE5hbWUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEFuIGFydGlmYWN0IG5hbWVkICR7YXJ0aWZhY3ROYW1lfSB3YXMgYWxyZWFkeSB3cml0dGVuIHRvIHRoaXMgc2Vzc2lvbmApO1xuICAgIH1cbiAgICBpZiAodGhpcy5sb2NrZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignU2Vzc2lvbiBoYXMgYWxyZWFkeSBiZWVuIGZpbmFsaXplZCcpO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiByZW5kZXJMZWdhY3lTdGFja3MoYXJ0aWZhY3RzOiB7IFtpZDogc3RyaW5nXTogY3hhcGkuQXJ0aWZhY3QgfSwgc3RvcmU6IElTZXNzaW9uU3RvcmUpIHtcbiAgLy8gc3BlY2lhbCBjYXNlIGZvciBiYWNrd2FyZHMgY29tcGF0LiBidWlsZCBhIGxpc3Qgb2Ygc3RhY2tzIGZvciB0aGUgbWFuaWZlc3RcbiAgY29uc3Qgc3RhY2tzID0gbmV3IEFycmF5PGN4YXBpLlN5bnRoZXNpemVkU3RhY2s+KCk7XG5cbiAgZm9yIChjb25zdCBbIGlkLCBhcnRpZmFjdCBdIG9mIE9iamVjdC5lbnRyaWVzKGFydGlmYWN0cykpIHtcbiAgICBpZiAoYXJ0aWZhY3QudHlwZSA9PT0gY3hhcGkuQXJ0aWZhY3RUeXBlLkF3c0Nsb3VkRm9ybWF0aW9uU3RhY2spIHtcbiAgICAgIGNvbnN0IHRlbXBsYXRlRmlsZSA9IGFydGlmYWN0LnByb3BlcnRpZXMgJiYgYXJ0aWZhY3QucHJvcGVydGllcy50ZW1wbGF0ZUZpbGU7XG4gICAgICBpZiAoIXRlbXBsYXRlRmlsZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgY2xvdWRmb3JtYXRpb24gYXJ0aWZhY3QuIE1pc3NpbmcgXCJ0ZW1wbGF0ZVwiIHByb3BlcnR5YCk7XG4gICAgICB9XG4gICAgICBjb25zdCB0ZW1wbGF0ZSA9IHN0b3JlLnJlYWRKc29uKHRlbXBsYXRlRmlsZSk7XG5cbiAgICAgIGNvbnN0IG1hdGNoID0gY3hhcGkuQVdTX0VOVl9SRUdFWC5leGVjKGFydGlmYWN0LmVudmlyb25tZW50KTtcbiAgICAgIGlmICghbWF0Y2gpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBcImVudmlyb25tZW50XCIgbXVzdCBtYXRjaCByZWdleDogJHtjeGFwaS5BV1NfRU5WX1JFR0VYfWApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzeW50aFN0YWNrOiBjeGFwaS5TeW50aGVzaXplZFN0YWNrID0ge1xuICAgICAgICBuYW1lOiBpZCxcbiAgICAgICAgZW52aXJvbm1lbnQ6IHsgbmFtZTogYXJ0aWZhY3QuZW52aXJvbm1lbnQuc3Vic3RyKCdhd3M6Ly8nLmxlbmd0aCksIGFjY291bnQ6IG1hdGNoWzFdLCByZWdpb246IG1hdGNoWzJdIH0sXG4gICAgICAgIHRlbXBsYXRlLFxuICAgICAgICBtZXRhZGF0YTogYXJ0aWZhY3QubWV0YWRhdGEgfHwge30sXG4gICAgICB9O1xuXG4gICAgICBpZiAoYXJ0aWZhY3QuZGVwZW5kZW5jaWVzICYmIGFydGlmYWN0LmRlcGVuZGVuY2llcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHN5bnRoU3RhY2suZGVwZW5kc09uID0gYXJ0aWZhY3QuZGVwZW5kZW5jaWVzO1xuICAgICAgfVxuXG4gICAgICBpZiAoYXJ0aWZhY3QubWlzc2luZykge1xuICAgICAgICBzeW50aFN0YWNrLm1pc3NpbmcgPSBhcnRpZmFjdC5taXNzaW5nO1xuICAgICAgfVxuXG4gICAgICBzdGFja3MucHVzaChzeW50aFN0YWNrKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gc3RhY2tzO1xufSJdfQ==