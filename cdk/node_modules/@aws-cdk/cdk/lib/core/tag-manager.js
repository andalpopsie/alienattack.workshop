"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const resource_1 = require("../cloudformation/resource");
/**
 * TagManager facilitates a common implementation of tagging for Constructs.
 */
class TagManager {
    constructor(tagType, resourceTypeName) {
        this.tagType = tagType;
        this.resourceTypeName = resourceTypeName;
        this.tags = {};
        this.removedTags = {};
    }
    /**
     * Adds the specified tag to the array of tags
     *
     * @param key The key value of the tag
     * @param value The value value of the tag
     * @param props A `TagProps` defaulted to applyToLaunchInstances true
     */
    setTag(key, value, props) {
        const tagProps = props || {};
        if (!this.canApplyTag(key, tagProps)) {
            // tag is blocked by a remove
            return;
        }
        tagProps.applyToLaunchedInstances = tagProps.applyToLaunchedInstances !== false;
        this.tags[key] = { value, props: tagProps };
        // ensure nothing is left in removeTags
        delete this.removedTags[key];
    }
    /**
     * Removes the specified tag from the array if it exists
     *
     * @param key The key of the tag to remove
     */
    removeTag(key, props) {
        const tagProps = props || {};
        const priority = tagProps.priority === undefined ? 0 : tagProps.priority;
        if (!this.canApplyTag(key, tagProps)) {
            // tag is blocked by a remove
            return;
        }
        delete this.tags[key];
        this.removedTags[key] = priority;
    }
    /**
     * Renders tags into the proper format based on TagType
     */
    renderTags() {
        const keys = Object.keys(this.tags);
        switch (this.tagType) {
            case resource_1.TagType.Standard: {
                const tags = [];
                for (const key of keys) {
                    tags.push({ key, value: this.tags[key].value });
                }
                return tags.length === 0 ? undefined : tags;
            }
            case resource_1.TagType.AutoScalingGroup: {
                const tags = [];
                for (const key of keys) {
                    tags.push({
                        key,
                        value: this.tags[key].value,
                        propagateAtLaunch: this.tags[key].props.applyToLaunchedInstances !== false
                    });
                }
                return tags.length === 0 ? undefined : tags;
            }
            case resource_1.TagType.Map: {
                const tags = {};
                for (const key of keys) {
                    tags[key] = this.tags[key].value;
                }
                return Object.keys(tags).length === 0 ? undefined : tags;
            }
            case resource_1.TagType.NotTaggable: {
                return undefined;
            }
        }
    }
    canApplyTag(key, props) {
        const include = props.includeResourceTypes || [];
        const exclude = props.excludeResourceTypes || [];
        const priority = props.priority === undefined ? 0 : props.priority;
        if (exclude.length !== 0 &&
            exclude.indexOf(this.resourceTypeName) !== -1) {
            return false;
        }
        if (include.length !== 0 &&
            include.indexOf(this.resourceTypeName) === -1) {
            return false;
        }
        if (this.tags[key]) {
            if (this.tags[key].props.priority !== undefined) {
                return priority >= this.tags[key].props.priority;
            }
        }
        if (this.removedTags[key]) {
            return priority >= this.removedTags[key];
        }
        return true;
    }
}
exports.TagManager = TagManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFnLW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0YWctbWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlEQUFxRDtBQThDckQ7O0dBRUc7QUFDSCxNQUFhLFVBQVU7SUFNckIsWUFBNkIsT0FBZ0IsRUFBbUIsZ0JBQXdCO1FBQTNELFlBQU8sR0FBUCxPQUFPLENBQVM7UUFBbUIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFRO1FBSnZFLFNBQUksR0FBUyxFQUFFLENBQUM7UUFFaEIsZ0JBQVcsR0FBNEIsRUFBRSxDQUFDO0lBRWlDLENBQUM7SUFFN0Y7Ozs7OztPQU1HO0lBQ0ksTUFBTSxDQUFDLEdBQVcsRUFBRSxLQUFhLEVBQUUsS0FBZ0I7UUFDeEQsTUFBTSxRQUFRLEdBQWEsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUV2QyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFDLEVBQUU7WUFDcEMsNkJBQTZCO1lBQzdCLE9BQU87U0FDUjtRQUNELFFBQVEsQ0FBQyx3QkFBd0IsR0FBRyxRQUFRLENBQUMsd0JBQXdCLEtBQUssS0FBSyxDQUFDO1FBQ2hGLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxDQUFDO1FBQzVDLHVDQUF1QztRQUN2QyxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUVEOzs7O09BSUc7SUFDSSxTQUFTLENBQUMsR0FBVyxFQUFFLEtBQWdCO1FBQzVDLE1BQU0sUUFBUSxHQUFHLEtBQUssSUFBSSxFQUFFLENBQUM7UUFDN0IsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLFFBQVEsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQztRQUN6RSxJQUFJLENBQUMs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QU8sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtZQUMvQyxPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ2xCLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUSxLQUFLLFNBQVMsRUFBRTtnQkFDL0MsT0FBTyxRQUFRLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUyxDQUFDO2FBQ25EO1NBQ0Y7UUFDRCxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDekIsT0FBTyxRQUFRLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUMxQztRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztDQUNGO0FBdkdELGdDQXVHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRhZ1R5cGUgfSBmcm9tICcuLi9jbG91ZGZvcm1hdGlvbi9yZXNvdXJjZSc7XG5cbi8qKlxuICogUHJvcGVydGllcyBUYWdzIGlzIGEgZGljdGlvbmFyeSBvZiB0YWdzIGFzIHN0cmluZ3NcbiAqL1xudHlwZSBUYWdzID0geyBba2V5OiBzdHJpbmddOiB7dmFsdWU6IHN0cmluZywgcHJvcHM6IFRhZ1Byb3BzIH19O1xuXG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIGEgdGFnXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgVGFnUHJvcHMge1xuICAvKipcbiAgICogSGFuZGxlcyBBdXRvU2NhbGluZ0dyb3VwIFByb3BhZ2F0ZUF0TGF1bmNoIHByb3BlcnR5XG4gICAqL1xuICBhcHBseVRvTGF1bmNoZWRJbnN0YW5jZXM/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBBbiBhcnJheSBvZiBSZXNvdXJjZSBUeXBlcyB0aGF0IHdpbGwgbm90IHJlY2VpdmUgdGhpcyB0YWdcbiAgICpcbiAgICogQW4gZW1wdHkgYXJyYXkgd2lsbCBhbGxvdyB0aGlzIHRhZyB0byBiZSBhcHBsaWVkIHRvIGFsbCByZXNvdXJjZXMuIEFcbiAgICogbm9uLWVtcHR5IGFycmF5IHdpbGwgYXBwbHkgdGhpcyB0YWcgb25seSBpZiB0aGUgUmVzb3VyY2UgdHlwZSBpcyBub3QgaW5cbiAgICogdGhpcyBhcnJheS5cbiAgICogQGRlZmF1bHQgW11cbiAgICovXG4gIGV4Y2x1ZGVSZXNvdXJjZVR5cGVzPzogc3RyaW5nW107XG5cbiAgLyoqXG4gICAqIEFuIGFycmF5IG9mIFJlc291cmNlIFR5cGVzIHRoYXQgd2lsbCByZWNlaXZlIHRoaXMgdGFnXG4gICAqXG4gICAqIEFuIGVtcHR5IGFycmF5IHdpbGwgbWF0Y2ggYW55IFJlc291cmNlLiBBIG5vbi1lbXB0eSBhcnJheSB3aWxsIGFwcGx5IHRoaXNcbiAgICogdGFnIG9ubHkgdG8gUmVzb3VyY2UgdHlwZXMgdGhhdCBhcmUgaW5jbHVkZWQgaW4gdGhpcyBhcnJheS5cbiAgICogQGRlZmF1bHQgW11cbiAgICovXG4gIGluY2x1ZGVSZXNvdXJjZVR5cGVzPzogc3RyaW5nW107XG5cbiAgLyoqXG4gICAqIEhpZ2hlciBvciBlcXVhbCBwcmlvcml0eSB0YWdzIHdpbGwgdGFrZSBwcmVjZWRlbmNlXG4gICAqXG4gICAqIFNldHRpbmcgcHJpb3JpdHkgd2lsbCBlbmFibGUgdGhlIHVzZXIgdG8gY29udHJvbCB0YWdzIHdoZW4gdGhleSBuZWVkIHRvIG5vdFxuICAgKiBmb2xsb3cgdGhlIGRlZmF1bHQgcHJlY2VkZW5jZSBwYXR0ZXJuIG9mIGxhc3QgYXBwbGllZCBhbmQgY2xvc2VzdCB0byB0aGVcbiAgICogY29uc3RydWN0IGluIHRoZSB0cmVlLlxuICAgKiBAZGVmYXVsdCAwIGZvciBUYWcgMSBmb3IgUmVtb3ZlVGFnXG4gICAqL1xuICBwcmlvcml0eT86IG51bWJlcjtcbn1cblxuLyoqXG4gKiBUYWdNYW5hZ2VyIGZhY2lsaXRhdGVzIGEgY29tbW9uIGltcGxlbWVudGF0aW9uIG9mIHRhZ2dpbmcgZm9yIENvbnN0cnVjdHMuXG4gKi9cbmV4cG9ydCBjbGFzcyBUYWdNYW5hZ2VyIHtcblxuICBwcml2YXRlIHJlYWRvbmx5IHRhZ3M6IFRhZ3MgPSB7fTtcblxuICBwcml2YXRlIHJlYWRvbmx5IHJlbW92ZWRUYWdzOiB7W2tleTogc3RyaW5nXTogbnVtYmVyfSA9IHt9O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgdGFnVHlwZTogVGFnVHlwZSwgcHJpdmF0ZSByZWFkb25seSByZXNvdXJjZVR5cGVOYW1lOiBzdHJpbmcpIHsgfVxuXG4gIC8qKlxuICAgKiBBZGRzIHRoZSBzcGVjaWZpZWQgdGFnIHRvIHRoZSBhcnJheSBvZiB0YWdzXG4gICAqXG4gICAqIEBwYXJhbSBrZXkgVGhlIGtleSB2YWx1ZSBvZiB0aGUgdGFnXG4gICAqIEBwYXJhbSB2YWx1ZSBUaGUgdmFsdWUgdmFsdWUgb2YgdGhlIHRhZ1xuICAgKiBAcGFyYW0gcHJvcHMgQSBgVGFnUHJvcHNgIGRlZmF1bHRlZCB0byBhcHBseVRvTGF1bmNoSW5zdGFuY2VzIHRydWVcbiAgICovXG4gIHB1YmxpYyBzZXRUYWcoa2V5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcsIHByb3BzPzogVGFnUHJvcHMpOiB2b2lkIHtcbiAgICBjb25zdCB0YWdQcm9wczogVGFnUHJvcHMgPSBwcm9wcyB8fCB7fTtcblxuICAgIGlmICghdGhpcy5jYW5BcHBseVRhZyhrZXksIHRhZ1Byb3BzKSkge1xuICAgICAgLy8gdGFnIGlzIGJsb2NrZWQgYnkgYSByZW1vdmVcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGFnUHJvcHMuYXBwbHlUb0xhdW5jaGVkSW5zdGFuY2VzID0gdGFnUHJvcHMuYXBwbHlUb0xhdW5jaGVkSW5zdGFuY2VzICE9PSBmYWxzZTtcbiAgICB0aGlzLnRhZ3Nba2V5XSA9IHsgdmFsdWUsIHByb3BzOiB0YWdQcm9wcyB9O1xuICAgIC8vIGVuc3VyZSBub3RoaW5nIGlzIGxlZnQgaW4gcmVtb3ZlVGFnc1xuICAgIGRlbGV0ZSB0aGlzLnJlbW92ZWRUYWdzW2tleV07XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyB0aGUgc3BlY2lmaWVkIHRhZyBmcm9tIHRoZSBhcnJheSBpZiBpdCBleGlzdHNcbiAgICpcbiAgICogQHBhcmFtIGtleSBUaGUga2V5IG9mIHRoZSB0YWcgdG8gcmVtb3ZlXG4gICAqL1xuICBwdWJsaWMgcmVtb3ZlVGFnKGtleTogc3RyaW5nLCBwcm9wcz86IFRhZ1Byb3BzKTogdm9pZCB7XG4gICAgY29uc3QgdGFnUHJvcHMgPSBwcm9wcyB8fCB7fTtcbiAgICBjb25zdCBwcmlvcml0eSA9IHRhZ1Byb3BzLnByaW9yaXR5ID09PSB1bmRlZmluZWQgPyAwIDogdGFnUHJvcHMucHJpb3JpdHk7XG4gICAgaWYgKCF0aGlzLmNhbkFwcGx5VGFnKGtleSwgdGFnUHJvcHMpKSB7XG4gICAgICAvLyB0YWcgaXMgYmxvY2tlZCBieSBhIHJlbW92ZVxuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBkZWxldGUgdGhpcy50YWdzW2tleV07XG4gICAgdGhpcy5yZW1vdmVkVGFnc1trZXldID0gcHJpb3JpdHk7XG4gIH1cblxuICAvKipcbiAgICogUmVuZGVycyB0YWdzIGludG8gdGhlIHByb3BlciBmb3JtYXQgYmFzZWQgb24gVGFnVHlwZVxuICAgKi9cbiAgcHVibGljIHJlbmRlclRhZ3MoKTogYW55IHtcbiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXModGhpcy50YWdzKTtcbiAgICBzd2l0Y2ggKHRoaXMudGFnVHlwZSkge1xuICAgICAgY2FzZSBUYWdUeXBlLlN0YW5kYXJkOiB7XG4gICAgICAgIGNvbnN0IHRhZ3M6IEFycmF5PHtrZXk6IHN0cmluZywgdmFsdWU6IHN0cmluZ30+ID0gW107XG4gICAgICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHtcbiAgICAgICAgICB0YWdzLnB1c2goe2tleSwgdmFsdWU6IHRoaXMudGFnc1trZXldLnZhbHVlfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRhZ3MubGVuZ3RoID09PSAwID8gdW5kZWZpbmVkIDogdGFncztcbiAgICAgIH1cbiAgICAgIGNhc2UgVGFnVHlwZS5BdXRvU2NhbGluZ0dyb3VwOiB7XG4gICAgICAgIGNvbnN0IHRhZ3M6IEFycmF5PHtrZXk6IHN0cmluZywgdmFsdWU6IHN0cmluZywgcHJvcGFnYXRlQXRMYXVuY2g6IGJvb2xlYW59PiA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7XG4gICAgICAgICAgdGFncy5wdXNoKHtcbiAgICAgICAgICAgIGtleSxcbiAgICAgICAgICAgIHZhbHVlOiB0aGlzLnRhZ3Nba2V5XS52YWx1ZSxcbiAgICAgICAgICAgIHByb3BhZ2F0ZUF0TGF1bmNoOiB0aGlzLnRhZ3Nba2V5XS5wcm9wcy5hcHBseVRvTGF1bmNoZWRJbnN0YW5jZXMgIT09IGZhbHNlfVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRhZ3MubGVuZ3RoID09PSAwID8gdW5kZWZpbmVkIDogdGFncztcbiAgICAgIH1cbiAgICAgIGNhc2UgVGFnVHlwZS5NYXA6IHtcbiAgICAgICAgY29uc3QgdGFnczoge1trZXk6IHN0cmluZ106IHN0cmluZ30gPSB7fTtcbiAgICAgICAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykge1xuICAgICAgICAgIHRhZ3Nba2V5XSA9IHRoaXMudGFnc1trZXldLnZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBPYmplY3Qua2V5cyh0YWdzKS5sZW5ndGggPT09IDAgPyB1bmRlZmluZWQgOiB0YWdzO1xuICAgICAgfVxuICAgICAgY2FzZSBUYWdUeXBlLk5vdFRhZ2dhYmxlOiB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjYW5BcHBseVRhZyhrZXk6IHN0cmluZywgcHJvcHM6IFRhZ1Byb3BzKTogYm9vbGVhbiB7XG4gICAgY29uc3QgaW5jbHVkZSA9IHByb3BzLmluY2x1ZGVSZXNvdXJjZVR5cGVzIHx8IFtdO1xuICAgIGNvbnN0IGV4Y2x1ZGUgPSBwcm9wcy5leGNsdWRlUmVzb3VyY2VUeXBlcyB8fCBbXTtcbiAgICBjb25zdCBwcmlvcml0eSA9IHByb3BzLnByaW9yaXR5ID09PSB1bmRlZmluZWQgPyAwIDogcHJvcHMucHJpb3JpdHk7XG4gICAgaWYgKGV4Y2x1ZGUubGVuZ3RoICE9PSAwICYmXG4gICAgICBleGNsdWRlLmluZGV4T2YodGhpcy5yZXNvdXJjZVR5cGVOYW1lKSAhPT0gLTEpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgaWYgKGluY2x1ZGUubGVuZ3RoICE9PSAwICYmXG4gICAgICBpbmNsdWRlLmluZGV4T2YodGhpcy5yZXNvdXJjZVR5cGVOYW1lKSA9PT0gLTEpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgaWYgKHRoaXMudGFnc1trZXldKSB7XG4gICAgICBpZiAodGhpcy50YWdzW2tleV0ucHJvcHMucHJpb3JpdHkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXR1cm4gcHJpb3JpdHkgPj0gdGhpcy50YWdzW2tleV0ucHJvcHMucHJpb3JpdHkhO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5yZW1vdmVkVGFnc1trZXldKSB7XG4gICAgICByZXR1cm4gcHJpb3JpdHkgPj0gdGhpcy5yZW1vdmVkVGFnc1trZXldO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxufVxuIl19