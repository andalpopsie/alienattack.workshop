"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const codepipeline = require("@aws-cdk/aws-codepipeline-api");
const iam = require("@aws-cdk/aws-iam");
/**
 * CodePipeline invoke Action that is provided by an AWS Lambda function.
 *
 * @see https://docs.aws.amazon.com/codepipeline/latest/userguide/actions-invoke-lambda-function.html
 */
class PipelineInvokeAction extends codepipeline.Action {
    constructor(props) {
        super(Object.assign({}, props, { category: codepipeline.ActionCategory.Invoke, provider: 'Lambda', artifactBounds: codepipeline.defaultBounds(), configuration: {
                FunctionName: props.lambda.functionName,
                UserParameters: props.userParameters
            } }));
        // handle input artifacts
        for (const inputArtifact of props.inputArtifacts || []) {
            this.addInputArtifact(inputArtifact);
        }
        // handle output artifacts
        for (const outputArtifactName of props.outputArtifactNames || []) {
            this.addOutputArtifact(outputArtifactName);
        }
        this.props = props;
    }
    outputArtifacts() {
        return this._outputArtifacts;
    }
    outputArtifact(artifactName) {
        const result = this._outputArtifacts.find(a => (a.artifactName === artifactName));
        if (result === undefined) {
            throw new Error(`Could not find the output Artifact with name '${artifactName}'`);
        }
        else {
            return result;
        }
    }
    bind(stage, _scope) {
        // allow pipeline to list functions
        stage.pipeline.role.addToPolicy(new iam.PolicyStatement()
            .addAction('lambda:ListFunctions')
            .addAllResources());
        // allow pipeline to invoke this lambda functionn
        stage.pipeline.role.addToPolicy(new iam.PolicyStatement()
            .addAction('lambda:InvokeFunction')
            .addResource(this.props.lambda.functionArn));
        // allow lambda to put job results for this pipeline.
        const addToPolicy = this.props.addPutJobResultPolicy !== undefined ? this.props.addPutJobResultPolicy : true;
        if (addToPolicy) {
            this.props.lambda.addToRolePolicy(new iam.PolicyStatement()
                .addAllResources() // to avoid cycles (see docs)
                .addAction('codepipeline:PutJobSuccessResult')
                .addAction('codepipeline:PutJobFailureResult'));
        }
    }
}
exports.PipelineInvokeAction = PipelineInvokeAction;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGlwZWxpbmUtYWN0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicGlwZWxpbmUtYWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsOERBQStEO0FBQy9ELHdDQUF5QztBQTJFekM7Ozs7R0FJRztBQUNILE1BQWEsb0JBQXFCLFNBQVEsWUFBWSxDQUFDLE1BQU07SUFHM0QsWUFBWSxLQUFnQztRQUMxQyxLQUFLLG1CQUNBLEtBQUssSUFDUixRQUFRLEVBQUUsWUFBWSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEVBQzVDLFFBQVEsRUFBRSxRQUFRLEVBQ2xCLGNBQWMsRUFBRSxZQUFZLENBQUMsYUFBYSxFQUFFLEVBQzVDLGFBQWEsRUFBRTtnQkFDYixZQUFZLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxZQUFZO2dCQUN2QyxjQUFjLEVBQUUsS0FBSyxDQUFDLGNBQWM7YUFDckMsSUFDRCxDQUFDO1FBRUgseUJBQXlCO1FBQ3pCLEtBQUssTUFBTSxhQUFhLElBQUksS0FBSyxDQUFDLGNBQWMsSUFBSSxFQUFFLEVBQUU7WUFDdEQsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxDQUFDO1NBQ3RDO1FBRUQsMEJBQTBCO1FBQzFCLEtBQUssTUFBTSxrQkFBa0IsSUFBSSxLQUFLLENBQUMsbUJBQW1CLElBQUksRUFBRSxFQUFFO1lBQ2hFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1NBQzVDO1FBRUQsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7SUFDckIsQ0FBQztJQUVNLGVBQWU7UUFDcEIsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7SUFDL0IsQ0FBQztJQUVNLGNBQWMsQ0FBQyxZQUFvQjtRQUN4QyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxLQUFLLFlBQVksQ0FBQyxDQUFDLENBQUM7UUFDbEYsSUFBSSxNQUFNLEtBQUssU0FBUyxFQUFFO1lBQ3hCLE1BQU0sSUFBSSxLQUFLLENBQUMsaURBQWlELFlBQVksR0FBRyxDQUFDLENBQUM7U0FDbkY7YUFBTTtZQUNMLE9BQU8sTUFBTSxDQUFDO1NBQ2Y7SUFDSCxDQUFDO0lBRVMsSUFBSSxDQUFDLEtBQTBCLEVBQUUsTUFBcUI7UUFDOUQsbUNBQW1DO1FBQ25DLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxlQUFlLEVBQUU7YUFDdEQsU0FBUyxDQUFDLHNCQUFzQixDQUFDO2FBQ2pDLGVBQWUsRUFBRSxDQUFDLENBQUM7UUFFdEIsaURBQWlEO1FBQ2pELEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxlQUFlLEVBQUU7YUFDdEQsU0FBUyxDQUFDLHVCQUF1QixDQUFDO2FBQ2xDLFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1FBRS9DLHFEQUFxRDtRQUNyRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLHFCQUFxQixLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQzdHLElBQUksV0FBVyxFQUFFO1lBQ2YsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLElBQUksR0FBRyxDQUFDLGVBQWUsRUFBRTtpQkFDeEQsZUFBZSxFQUFFLENBQUMsNkJBQTZCO2lCQUMvQyxTQUFTLENBQUMsa0NBQWtDLENBQUM7aUJBQzdDLFNBQVMsQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDLENBQUM7U0FDbkQ7SUFDSCxDQUFDO0NBQ0Y7QUE3REQsb0RBNkRDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNvZGVwaXBlbGluZSA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2F3cy1jb2RlcGlwZWxpbmUtYXBpJyk7XG5pbXBvcnQgaWFtID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLWlhbScpO1xuaW1wb3J0IGNkayA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2NkaycpO1xuaW1wb3J0IHsgSUZ1bmN0aW9uIH0gZnJvbSAnLi9mdW5jdGlvbi1iYXNlJztcblxuLyoqXG4gKiBDb21tb24gcHJvcGVydGllcyBmb3IgY3JlYXRpbmcgYSB7QGxpbmsgUGlwZWxpbmVJbnZva2VBY3Rpb259IC1cbiAqIGVpdGhlciBkaXJlY3RseSwgdGhyb3VnaCBpdHMgY29uc3RydWN0b3IsXG4gKiBvciB0aHJvdWdoIHtAbGluayBJRnVuY3Rpb24jdG9Db2RlUGlwZWxpbmVJbnZva2VBY3Rpb259LlxuICovXG5leHBvcnQgaW50ZXJmYWNlIENvbW1vblBpcGVsaW5lSW52b2tlQWN0aW9uUHJvcHMgZXh0ZW5kcyBjb2RlcGlwZWxpbmUuQ29tbW9uQWN0aW9uUHJvcHMge1xuICAvLyBiZWNhdXNlIG9mIEBzZWUgbGlua3NcbiAgLy8gdHNsaW50OmRpc2FibGU6bWF4LWxpbmUtbGVuZ3RoXG5cbiAgLyoqXG4gICAqIFRoZSBvcHRpb25hbCBpbnB1dCBBcnRpZmFjdHMgb2YgdGhlIEFjdGlvbi5cbiAgICogQSBMYW1iZGEgQWN0aW9uIGNhbiBoYXZlIHVwIHRvIDUgaW5wdXRzLlxuICAgKiBUaGUgaW5wdXRzIHdpbGwgYXBwZWFyIGluIHRoZSBldmVudCBwYXNzZWQgdG8gdGhlIExhbWJkYSxcbiAgICogdW5kZXIgdGhlIGAnQ29kZVBpcGVsaW5lLmpvYicuZGF0YS5pbnB1dEFydGlmYWN0c2AgcGF0aC5cbiAgICpcbiAgICogQGRlZmF1bHQgdGhlIEFjdGlvbiB3aWxsIG5vdCBoYXZlIGFueSBpbnB1dHNcbiAgICogQHNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vY29kZXBpcGVsaW5lL2xhdGVzdC91c2VyZ3VpZGUvYWN0aW9ucy1pbnZva2UtbGFtYmRhLWZ1bmN0aW9uLmh0bWwjYWN0aW9ucy1pbnZva2UtbGFtYmRhLWZ1bmN0aW9uLWpzb24tZXZlbnQtZXhhbXBsZVxuICAgKi9cbiAgaW5wdXRBcnRpZmFjdHM/OiBjb2RlcGlwZWxpbmUuQXJ0aWZhY3RbXTtcblxuICAvLyB0c2xpbnQ6ZW5hYmxlOm1heC1saW5lLWxlbmd0aFxuXG4gIC8qKlxuICAgKiBUaGUgb3B0aW9uYWwgbmFtZXMgb2YgdGhlIG91dHB1dCBBcnRpZmFjdHMgb2YgdGhlIEFjdGlvbi5cbiAgICogQSBMYW1iZGEgQWN0aW9uIGNhbiBoYXZlIHVwIHRvIDUgb3V0cHV0cy5cbiAgICogVGhlIG91dHB1dHMgd2lsbCBhcHBlYXIgaW4gdGhlIGV2ZW50IHBhc3NlZCB0byB0aGUgTGFtYmRhLFxuICAgKiB1bmRlciB0aGUgYCdDb2RlUGlwZWxpbmUuam9iJy5kYXRhLm91dHB1dEFydGlmYWN0c2AgcGF0aC5cbiAgICogSXQgaXMgdGhlIHJlc3BvbnNpYmlsaXR5IG9mIHRoZSBMYW1iZGEgdG8gdXBsb2FkIFpJUCBmaWxlcyB3aXRoIHRoZSBBcnRpZmFjdCBjb250ZW50cyB0byB0aGUgcHJvdmlkZWQgbG9jYXRpb25zLlxuICAgKlxuICAgKiBAZGVmYXVsdCB0aGUgQWN0aW9uIHdpbGwgbm90IGhhdmUgYW55IG91dHB1dHNcbiAgICovXG4gIG91dHB1dEFydGlmYWN0TmFtZXM/OiBzdHJpbmdbXTtcblxuICAvKipcbiAgICogU3RyaW5nIHRvIGJlIHVzZWQgaW4gdGhlIGV2ZW50IGRhdGEgcGFyYW1ldGVyIHBhc3NlZCB0byB0aGUgTGFtYmRhXG4gICAqIGZ1bmN0aW9uXG4gICAqXG4gICAqIFNlZSBhbiBleGFtcGxlIEpTT04gZXZlbnQgaW4gdGhlIENvZGVQaXBlbGluZSBkb2N1bWVudGF0aW9uLlxuICAgKlxuICAgKiBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vY29kZXBpcGVsaW5lL2xhdGVzdC91c2VyZ3VpZGUvYWN0aW9ucy1pbnZva2UtbGFtYmRhLWZ1bmN0aW9uLmh0bWwjYWN0aW9ucy1pbnZva2UtbGFtYmRhLWZ1bmN0aW9uLWpzb24tZXZlbnQtZXhhbXBsZVxuICAgKi9cbiAgdXNlclBhcmFtZXRlcnM/OiBhbnk7XG5cbiAgLyoqXG4gICAqIEFkZHMgdGhlIFwiY29kZXBpcGVsaW5lOlB1dEpvYlN1Y2Nlc3NSZXN1bHRcIiBhbmRcbiAgICogXCJjb2RlcGlwZWxpbmU6UHV0Sm9iRmFpbHVyZVJlc3VsdFwiIGZvciAnKicgcmVzb3VyY2UgdG8gdGhlIExhbWJkYVxuICAgKiBleGVjdXRpb24gcm9sZSBwb2xpY3kuXG4gICAqXG4gICAqIE5PVEU6IHRoZSByZWFzb24gd2UgY2FuJ3QgYWRkIHRoZSBzcGVjaWZpYyBwaXBlbGluZSBBUk4gYXMgYSByZXNvdXJjZSBpc1xuICAgKiB0byBhdm9pZCBhIGN5Y2xpYyBkZXBlbmRlbmN5IGJldHdlZW4gdGhlIHBpcGVsaW5lIGFuZCB0aGUgTGFtYmRhIGZ1bmN0aW9uXG4gICAqICh0aGUgcGlwZWxpbmUgcmVmZXJlbmNlcykgdGhlIExhbWJkYSBhbmQgdGhlIExhbWJkYSBuZWVkcyBwZXJtaXNzaW9ucyBvblxuICAgKiB0aGUgcGlwZWxpbmUuXG4gICAqXG4gICAqIEBzZWVcbiAgICogaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2NvZGVwaXBlbGluZS9sYXRlc3QvdXNlcmd1aWRlL2FjdGlvbnMtaW52b2tlLWxhbWJkYS1mdW5jdGlvbi5odG1sI2FjdGlvbnMtaW52b2tlLWxhbWJkYS1mdW5jdGlvbi1jcmVhdGUtZnVuY3Rpb25cbiAgICpcbiAgICogQGRlZmF1bHQgdHJ1ZVxuICAgKi9cbiAgYWRkUHV0Sm9iUmVzdWx0UG9saWN5PzogYm9vbGVhbjtcbn1cblxuLyoqXG4gKiBDb25zdHJ1Y3Rpb24gcHJvcGVydGllcyBvZiB0aGUge0BsaW5rIFBpcGVsaW5lSW52b2tlQWN0aW9uIExhbWJkYSBpbnZva2UgQ29kZVBpcGVsaW5lIEFjdGlvbn0uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgUGlwZWxpbmVJbnZva2VBY3Rpb25Qcm9wcyBleHRlbmRzIENvbW1vblBpcGVsaW5lSW52b2tlQWN0aW9uUHJvcHMge1xuICAvKipcbiAgICogVGhlIGxhbWJkYSBmdW5jdGlvbiB0byBpbnZva2UuXG4gICAqL1xuICBsYW1iZGE6IElGdW5jdGlvbjtcbn1cblxuLyoqXG4gKiBDb2RlUGlwZWxpbmUgaW52b2tlIEFjdGlvbiB0aGF0IGlzIHByb3ZpZGVkIGJ5IGFuIEFXUyBMYW1iZGEgZnVuY3Rpb24uXG4gKlxuICogQHNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vY29kZXBpcGVsaW5lL2xhdGVzdC91c2VyZ3VpZGUvYWN0aW9ucy1pbnZva2UtbGFtYmRhLWZ1bmN0aW9uLmh0bWxcbiAqL1xuZXhwb3J0IGNsYXNzIFBpcGVsaW5lSW52b2tlQWN0aW9uIGV4dGVuZHMgY29kZXBpcGVsaW5lLkFjdGlvbiB7XG4gIHByaXZhdGUgcmVhZG9ubHkgcHJvcHM6IFBpcGVsaW5lSW52b2tlQWN0aW9uUHJvcHM7XG5cbiAgY29uc3RydWN0b3IocHJvcHM6IFBpcGVsaW5lSW52b2tlQWN0aW9uUHJvcHMpIHtcbiAgICBzdXBlcih7XG4gICAgICAuLi5wcm9wcyxcbiAgICAgIGNhdGVnb3J5OiBjb2RlcGlwZWxpbmUuQWN0aW9uQ2F0ZWdvcnkuSW52b2tlLFxuICAgICAgcHJvdmlkZXI6ICdMYW1iZGEnLFxuICAgICAgYXJ0aWZhY3RCb3VuZHM6IGNvZGVwaXBlbGluZS5kZWZhdWx0Qm91bmRzKCksXG4gICAgICBjb25maWd1cmF0aW9uOiB7XG4gICAgICAgIEZ1bmN0aW9uTmFtZTogcHJvcHMubGFtYmRhLmZ1bmN0aW9uTmFtZSxcbiAgICAgICAgVXNlclBhcmFtZXRlcnM6IHByb3BzLnVzZXJQYXJhbWV0ZXJzXG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyBoYW5kbGUgaW5wdXQgYXJ0aWZhY3RzXG4gICAgZm9yIChjb25zdCBpbnB1dEFydGlmYWN0IG9mIHByb3BzLmlucHV0QXJ0aWZhY3RzIHx8IFtdKSB7XG4gICAgICB0aGlzLmFkZElucHV0QXJ0aWZhY3QoaW5wdXRBcnRpZmFjdCk7XG4gICAgfVxuXG4gICAgLy8gaGFuZGxlIG91dHB1dCBhcnRpZmFjdHNcbiAgICBmb3IgKGNvbnN0IG91dHB1dEFydGlmYWN0TmFtZSBvZiBwcm9wcy5vdXRwdXRBcnRpZmFjdE5hbWVzIHx8IFtdKSB7XG4gICAgICB0aGlzLmFkZE91dHB1dEFydGlmYWN0KG91dHB1dEFydGlmYWN0TmFtZSk7XG4gICAgfVxuXG4gICAgdGhpcy5wcm9wcyA9IHByb3BzO1xuICB9XG5cbiAgcHVibGljIG91dHB1dEFydGlmYWN0cygpOiBjb2RlcGlwZWxpbmUuQXJ0aWZhY3RbXSB7XG4gICAgcmV0dXJuIHRoaXMuX291dHB1dEFydGlmYWN0cztcbiAgfVxuXG4gIHB1YmxpYyBvdXRwdXRBcnRpZmFjdChhcnRpZmFjdE5hbWU6IHN0cmluZyk6IGNvZGVwaXBlbGluZS5BcnRpZmFjdCB7XG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5fb3V0cHV0QXJ0aWZhY3RzLmZpbmQoYSA9PiAoYS5hcnRpZmFjdE5hbWUgPT09IGFydGlmYWN0TmFtZSkpO1xuICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCB0aGUgb3V0cHV0IEFydGlmYWN0IHdpdGggbmFtZSAnJHthcnRpZmFjdE5hbWV9J2ApO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBiaW5kKHN0YWdlOiBjb2RlcGlwZWxpbmUuSVN0YWdlLCBfc2NvcGU6IGNkay5Db25zdHJ1Y3QpOiB2b2lkIHtcbiAgICAvLyBhbGxvdyBwaXBlbGluZSB0byBsaXN0IGZ1bmN0aW9uc1xuICAgIHN0YWdlLnBpcGVsaW5lLnJvbGUuYWRkVG9Qb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoKVxuICAgICAgLmFkZEFjdGlvbignbGFtYmRhOkxpc3RGdW5jdGlvbnMnKVxuICAgICAgLmFkZEFsbFJlc291cmNlcygpKTtcblxuICAgIC8vIGFsbG93IHBpcGVsaW5lIHRvIGludm9rZSB0aGlzIGxhbWJkYSBmdW5jdGlvbm5cbiAgICBzdGFnZS5waXBlbGluZS5yb2xlLmFkZFRvUG9saWN5KG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KClcbiAgICAgIC5hZGRBY3Rpb24oJ2xhbWJkYTpJbnZva2VGdW5jdGlvbicpXG4gICAgICAuYWRkUmVzb3VyY2UodGhpcy5wcm9wcy5sYW1iZGEuZnVuY3Rpb25Bcm4pKTtcblxuICAgIC8vIGFsbG93IGxhbWJkYSB0byBwdXQgam9iIHJlc3VsdHMgZm9yIHRoaXMgcGlwZWxpbmUuXG4gICAgY29uc3QgYWRkVG9Qb2xpY3kgPSB0aGlzLnByb3BzLmFkZFB1dEpvYlJlc3VsdFBvbGljeSAhPT0gdW5kZWZpbmVkID8gdGhpcy5wcm9wcy5hZGRQdXRKb2JSZXN1bHRQb2xpY3kgOiB0cnVlO1xuICAgIGlmIChhZGRUb1BvbGljeSkge1xuICAgICAgdGhpcy5wcm9wcy5sYW1iZGEuYWRkVG9Sb2xlUG9saWN5KG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KClcbiAgICAgICAgLmFkZEFsbFJlc291cmNlcygpIC8vIHRvIGF2b2lkIGN5Y2xlcyAoc2VlIGRvY3MpXG4gICAgICAgIC5hZGRBY3Rpb24oJ2NvZGVwaXBlbGluZTpQdXRKb2JTdWNjZXNzUmVzdWx0JylcbiAgICAgICAgLmFkZEFjdGlvbignY29kZXBpcGVsaW5lOlB1dEpvYkZhaWx1cmVSZXN1bHQnKSk7XG4gICAgfVxuICB9XG59XG4iXX0=