"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const crypto = require("crypto");
const logging_1 = require("./logging");
const os_1 = require("./os");
const please_hold_1 = require("./util/please-hold");
/**
 * Build and upload a Docker image
 *
 * Permanently identifying images is a bit of a bust. Newer Docker version use
 * a digest (sha256:xxxx) as an image identifier, which is pretty good to avoid
 * spurious rebuilds. However, this digest is calculated over a manifest that
 * includes metadata that is liable to change. For example, as soon as we
 * push the Docker image to a repository, the digest changes. This makes the
 * digest worthless to determe whether we already pushed an image, for example.
 *
 * As a workaround, we calculate our own digest over parts of the manifest that
 * are unlikely to change, and tag based on that.
 *
 * When running in CI, we pull the latest image first and use it as cache for
 * the build. Generally pulling will be faster than building, especially for
 * Dockerfiles with lots of OS/code packages installation or changes only in
 * the bottom layers. When running locally chances are that we already have
 * layers cache available.
 *
 * CI is detected by the presence of the `CI` environment variable or
 * the `--ci` command line option.
 */
async function prepareContainerAsset(asset, toolkitInfo, reuse, ci) {
    if (reuse) {
        return [
            { ParameterKey: asset.imageNameParameter, UsePreviousValue: true },
        ];
    }
    logging_1.debug(' ðŸ‘‘  Preparing Docker image asset:', asset.path);
    const buildHold = new please_hold_1.PleaseHold(` âŒ› Building Asset Docker image ${asset.id} from ${asset.path}; this may take a while.`);
    try {
        const ecr = await toolkitInfo.prepareEcrRepository(asset.id);
        const latest = `${ecr.repositoryUri}:latest`;
        let loggedIn = false;
        // In CI we try to pull latest first
        if (ci) {
            await dockerLogin(toolkitInfo);
            loggedIn = true;
            try {
                await os_1.shell(['docker', 'pull', latest]);
            }
            catch (e) {
                logging_1.debug('Failed to pull latest image from ECR repository');
            }
        }
        buildHold.start();
        const baseCommand = ['docker',
            'build',
            '--quiet',
            asset.path];
        const command = ci
            ? [...baseCommand, '--cache-from', latest] // This does not fail if latest is not available
            : baseCommand;
        const imageId = (await os_1.shell(command, { quiet: true })).trim();
        buildHold.stop();
        const tag = await calculateImageFingerprint(imageId);
        logging_1.debug(` âŒ›  Image has tag ${tag}, checking ECR repository`);
        const imageExists = await toolkitInfo.checkEcrImage(ecr.repositoryName, tag);
        if (imageExists) {
            logging_1.debug(' ðŸ‘‘  Image already uploaded.');
        }
        else {
            // Login and push
            logging_1.debug(` âŒ›  Image needs to be uploaded first.`);
            if (!loggedIn) { // We could be already logged in if in CI
                await dockerLogin(toolkitInfo);
                loggedIn = true;
            }
            const qualifiedImageName = `${ecr.repositoryUri}:${tag}`;
            await os_1.shell(['docker', 'tag', imageId, qualifiedImageName]);
            // There's no way to make this quiet, so we can't use a PleaseHold. Print a header message.
            logging_1.print(` âŒ› Pushing Docker image for ${asset.path}; this may take a while.`);
            await os_1.shell(['docker', 'push', qualifiedImageName]);
            logging_1.debug(` ðŸ‘‘  Docker image for ${asset.path} pushed.`);
        }
        if (!loggedIn) { // We could be already logged in if in CI or if image did not exist
            await dockerLogin(toolkitInfo);
        }
        // Always tag and push latest
        await os_1.shell(['docker', 'tag', imageId, latest]);
        await os_1.shell(['docker', 'push', latest]);
        return [
            { ParameterKey: asset.imageNameParameter, ParameterValue: `${ecr.repositoryName}:${tag}` },
        ];
    }
    catch (e) {
        if (e.code === 'ENOENT') {
            // tslint:disable-next-line:max-line-length
            throw new Error('Error building Docker image asset; you need to have Docker installed in order to be able to build image assets. Please install Docker and try again.');
        }
        throw e;
    }
    finally {
        buildHold.stop();
    }
}
exports.prepareContainerAsset = prepareContainerAsset;
/**
 * Get credentials from ECR and run docker login
 */
async function dockerLogin(toolkitInfo) {
    const credentials = await toolkitInfo.getEcrCredentials();
    await os_1.shell(['docker', 'login',
        '--username', credentials.username,
        '--password', credentials.password,
        credentials.endpoint]);
}
/**
 * Calculate image fingerprint.
 *
 * The fingerprint has a high likelihood to be the same across repositories.
 * (As opposed to Docker's built-in image digest, which changes as soon
 * as the image is uploaded since it includes the tags that an image has).
 *
 * The fingerprint will be used as a tag to identify a particular image.
 */
async function calculateImageFingerprint(imageId) {
    const manifestString = await os_1.shell(['docker', 'inspect', imageId], { quiet: true });
    const manifest = JSON.parse(manifestString)[0];
    // Id can change
    delete manifest.Id;
    // Repository-based identifiers are out
    delete manifest.RepoTags;
    delete manifest.RepoDigests;
    // Metadata that has no bearing on the image contents
    delete manifest.Created;
    // We're interested in the image itself, not any running instaces of it
    delete manifest.Container;
    delete manifest.ContainerConfig;
    // We're not interested in the Docker version used to create this image
    delete manifest.DockerVersion;
    // On some Docker versions Metadata contains a LastTagTime which updates
    // on every push, causing us to miss all cache hits.
    delete manifest.Metadata;
    // GraphDriver is about running the image, not about the image itself.
    delete manifest.GraphDriver;
    return crypto.createHash('sha256').update(JSON.stringify(manifest)).digest('hex');
}
/**
 * Example of a Docker manifest
 *
 * [
 *     {
 *         "Id": "sha256:3a90542991d03007fd1d8f3b3a6ab04ebb02386785430fe48a867768a048d828",
 *         "RepoTags": [
 *             "993655754359.dkr.ecr.us-east-1.amazonaws.com/cdk/awsecsintegimage7c15b8c6:latest"
 *         ],
 *         "RepoDigests": [
 *             "993655754359.dkr.ecr.us-east-1.amazo....5e50c0cfc3f2355191934b05df68cd3339a044959111ffec2e14765"
 *         ],
 *         "Parent": "sha256:465720f8f43c9c0aff5dcc731d4e368a3927cae4e885442d4ba0bf8a867b7561",
 *         "Comment": "",
 *         "Created": "2018-10-17T10:16:40.775888476Z",
 *         "Container": "20f145d2e7fbf126ca9f4422497b932bc96b5faa038dc032de1e246f64e03a66",
 *         "ContainerConfig": {
 *             "Hostname": "9b48b580a312",
 *             "Domainname": "",
 *             "User": "",
 *             "AttachStdin": false,
 *             "AttachStdout": false,
 *             "AttachStderr": false,
 *             "ExposedPorts": {
 *                 "8000/tcp": {}
 *             },
 *             "Tty": false,
 *             "OpenStdin": false,
 *             "StdinOnce": false,
 *             "Env": [
 *                 "PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
 *                 "LANG=C.UTF-8",
 *                 "GPG_KEY=0D96DF4D4110E5C43FBFB17F2D347EA6AA65421D",
 *                 "PYTHON_VERSION=3.6.6",
 *                 "PYTHON_PIP_VERSION=18.1"
 *             ],
 *             "Cmd": [
 *                 "/bin/sh",
 *                 "-c",
 *                 "#(nop) ",
 *                 "CMD [\"/bin/sh\" \"-c\" \"python3 index.py\"]"
 *             ],
 *             "ArgsEscaped": true,
 *             "Image": "sha256:465720f8f43c9c0aff5dcc731d4e368a3927cae4e885442d4ba0bf8a867b7561",
 *             "Volumes": null,
 *             "WorkingDir": "/code",
 *             "Entrypoint": null,
 *             "OnBuild": [],
 *             "Labels": {}
 *         },
 *         "DockerVersion": "17.03.2-ce",
 *         "Author": "",
 *         "Config": {
 *             "Hostname": "9b48b580a312",
 *             "Domainname": "",
 *             "User": "",
 *             "AttachStdin": false,
 *             "AttachStdout": false,
 *             "AttachStderr": false,
 *             "ExposedPorts": {
 *                 "8000/tcp": {}
 *             },
 *             "Tty": false,
 *             "OpenStdin": false,
 *             "StdinOnce": false,
 *             "Env": [
 *                 "PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
 *                 "LANG=C.UTF-8",
 *                 "GPG_KEY=0D96DF4D4110E5C43FBFB17F2D347EA6AA65421D",
 *                 "PYTHON_VERSION=3.6.6",
 *                 "PYTHON_PIP_VERSION=18.1"
 *             ],
 *             "Cmd": [
 *                 "/bin/sh",
 *                 "-c",
 *                 "python3 index.py"
 *             ],
 *             "ArgsEscaped": true,
 *             "Image": "sha256:465720f8f43c9c0aff5dcc731d4e368a3927cae4e885442d4ba0bf8a867b7561",
 *             "Volumes": null,
 *             "WorkingDir": "/code",
 *             "Entrypoint": null,
 *             "OnBuild": [],
 *             "Labels": {}
 *         },
 *         "Architecture": "amd64",
 *         "Os": "linux",
 *         "Size": 917730468,
 *         "VirtualSize": 917730468,
 *         "GraphDriver": {
 *             "Name": "aufs",
 *             "Data": null
 *         },
 *         "RootFS": {
 *             "Type": "layers",
 *             "Layers": [
 *                 "sha256:f715ed19c28b66943ac8bc12dbfb828e8394de2530bbaf1ecce906e748e4fdff",
 *                 "sha256:8bb25f9cdc41e7d085033af15a522973b44086d6eedd24c11cc61c9232324f77",
 *                 "sha256:08a01612ffca33483a1847c909836610610ce523fb7e1aca880140ee84df23e9",
 *                 "sha256:1191b3f5862aa9231858809b7ac8b91c0b727ce85c9b3279932f0baacc92967d",
 *                 "sha256:9978d084fd771e0b3d1acd7f3525d1b25288ababe9ad8ed259b36101e4e3addd",
 *                 "sha256:2f4f74d3821ecbdd60b5d932452ea9e30cecf902334165c4a19837f6ee636377",
 *                 "sha256:003bb6178bc3218242d73e51d5e9ab2f991dc607780194719c6bd4c8c412fe8c",
 *                 "sha256:15b32d849da2239b1af583f9381c7a75d7aceba12f5ddfffa7a059116cf05ab9",
 *                 "sha256:6e5c5f6bf043bc634378b1e4b61af09be74741f2ac80204d7a373713b1fd5a40",
 *                 "sha256:3260e00e353bfb765b25597d13868c2ef64cb3d509875abcfb58c4e9bf7f4ee2",
 *                 "sha256:f3274b75856311e92e14a1270c78737c86456d6353fe4a83bd2e81bcd2a996ea"
 *             ]
 *         }
 *     }
 * ]
 */
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9ja2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZG9ja2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsaUNBQWtDO0FBRWxDLHVDQUF5QztBQUN6Qyw2QkFBNkI7QUFDN0Isb0RBQWdEO0FBRWhEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FxQkc7QUFDSSxLQUFLLFVBQVUscUJBQXFCLENBQUMsS0FBdUMsRUFDdkMsV0FBd0IsRUFDeEIsS0FBYyxFQUNkLEVBQVk7SUFFdEQsSUFBSSxLQUFLLEVBQUU7UUFDVCxPQUFPO1lBQ0wsRUFBRSxZQUFZLEVBQUUsS0FBSyxDQUFDLGtCQUFrQixFQUFFLGdCQUFnQixFQUFFLElBQUksRUFBRTtTQUNuRSxDQUFDO0tBQ0g7SUFFRCxlQUFLLENBQUMsb0NBQW9DLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRXhELE1BQU0sU0FBUyxHQUFHLElBQUksd0JBQVUsQ0FBQyxrQ0FBa0MsS0FBSyxDQUFDLEVBQUUsU0FBUyxLQUFLLENBQUMsSUFBSSwwQkFBMEIsQ0FBQyxDQUFDO0lBQzFILElBQUk7UUFDRixNQUFNLEdBQUcsR0FBRyxNQUFNLFdBQVcsQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDN0QsTUFBTSxNQUFNLEdBQUcsR0FBRyxHQUFHLENBQUMsYUFBYSxTQUFTLENBQUM7UUFFN0MsSUFBSSxRQUFRLEdBQUcsS0FBSyxDQUFDO1FBRXJCLG9DQUFvQztRQUNwQyxJQUFJLEVBQUUsRUFBRTtZQUNOLE1BQU0sV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQy9CLFFBQVEsR0FBRyxJQUFJLENBQUM7WUFFaEIsSUFBSTtnQkFDRixNQUFNLFVBQUssQ0FBQyxDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQzthQUN6QztZQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNWLGVBQUssQ0FBQyxpREFBaUQsQ0FBQyxDQUFD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Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQStHRyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnRhaW5lckltYWdlQXNzZXRNZXRhZGF0YUVudHJ5IH0gZnJvbSAnQGF3cy1jZGsvY3gtYXBpJztcbmltcG9ydCB7IENsb3VkRm9ybWF0aW9uIH0gZnJvbSAnYXdzLXNkayc7XG5pbXBvcnQgY3J5cHRvID0gcmVxdWlyZSgnY3J5cHRvJyk7XG5pbXBvcnQgeyBUb29sa2l0SW5mbyB9IGZyb20gJy4vYXBpL3Rvb2xraXQtaW5mbyc7XG5pbXBvcnQgeyBkZWJ1ZywgcHJpbnQgfSBmcm9tICcuL2xvZ2dpbmcnO1xuaW1wb3J0IHsgc2hlbGwgfSBmcm9tICcuL29zJztcbmltcG9ydCB7IFBsZWFzZUhvbGQgfSBmcm9tICcuL3V0aWwvcGxlYXNlLWhvbGQnO1xuXG4vKipcbiAqIEJ1aWxkIGFuZCB1cGxvYWQgYSBEb2NrZXIgaW1hZ2VcbiAqXG4gKiBQZXJtYW5lbnRseSBpZGVudGlmeWluZyBpbWFnZXMgaXMgYSBiaXQgb2YgYSBidXN0LiBOZXdlciBEb2NrZXIgdmVyc2lvbiB1c2VcbiAqIGEgZGlnZXN0IChzaGEyNTY6eHh4eCkgYXMgYW4gaW1hZ2UgaWRlbnRpZmllciwgd2hpY2ggaXMgcHJldHR5IGdvb2QgdG8gYXZvaWRcbiAqIHNwdXJpb3VzIHJlYnVpbGRzLiBIb3dldmVyLCB0aGlzIGRpZ2VzdCBpcyBjYWxjdWxhdGVkIG92ZXIgYSBtYW5pZmVzdCB0aGF0XG4gKiBpbmNsdWRlcyBtZXRhZGF0YSB0aGF0IGlzIGxpYWJsZSB0byBjaGFuZ2UuIEZvciBleGFtcGxlLCBhcyBzb29uIGFzIHdlXG4gKiBwdXNoIHRoZSBEb2NrZXIgaW1hZ2UgdG8gYSByZXBvc2l0b3J5LCB0aGUgZGlnZXN0IGNoYW5nZXMuIFRoaXMgbWFrZXMgdGhlXG4gKiBkaWdlc3Qgd29ydGhsZXNzIHRvIGRldGVybWUgd2hldGhlciB3ZSBhbHJlYWR5IHB1c2hlZCBhbiBpbWFnZSwgZm9yIGV4YW1wbGUuXG4gKlxuICogQXMgYSB3b3JrYXJvdW5kLCB3ZSBjYWxjdWxhdGUgb3VyIG93biBkaWdlc3Qgb3ZlciBwYXJ0cyBvZiB0aGUgbWFuaWZlc3QgdGhhdFxuICogYXJlIHVubGlrZWx5IHRvIGNoYW5nZSwgYW5kIHRhZyBiYXNlZCBvbiB0aGF0LlxuICpcbiAqIFdoZW4gcnVubmluZyBpbiBDSSwgd2UgcHVsbCB0aGUgbGF0ZXN0IGltYWdlIGZpcnN0IGFuZCB1c2UgaXQgYXMgY2FjaGUgZm9yXG4gKiB0aGUgYnVpbGQuIEdlbmVyYWxseSBwdWxsaW5nIHdpbGwgYmUgZmFzdGVyIHRoYW4gYnVpbGRpbmcsIGVzcGVjaWFsbHkgZm9yXG4gKiBEb2NrZXJmaWxlcyB3aXRoIGxvdHMgb2YgT1MvY29kZSBwYWNrYWdlcyBpbnN0YWxsYXRpb24gb3IgY2hhbmdlcyBvbmx5IGluXG4gKiB0aGUgYm90dG9tIGxheWVycy4gV2hlbiBydW5uaW5nIGxvY2FsbHkgY2hhbmNlcyBhcmUgdGhhdCB3ZSBhbHJlYWR5IGhhdmVcbiAqIGxheWVycyBjYWNoZSBhdmFpbGFibGUuXG4gKlxuICogQ0kgaXMgZGV0ZWN0ZWQgYnkgdGhlIHByZXNlbmNlIG9mIHRoZSBgQ0lgIGVudmlyb25tZW50IHZhcmlhYmxlIG9yXG4gKiB0aGUgYC0tY2lgIGNvbW1hbmQgbGluZSBvcHRpb24uXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwcmVwYXJlQ29udGFpbmVyQXNzZXQoYXNzZXQ6IENvbnRhaW5lckltYWdlQXNzZXRNZXRhZGF0YUVudHJ5LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b29sa2l0SW5mbzogVG9vbGtpdEluZm8sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldXNlOiBib29sZWFuLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaT86IGJvb2xlYW4pOiBQcm9taXNlPENsb3VkRm9ybWF0aW9uLlBhcmFtZXRlcltdPiB7XG5cbiAgaWYgKHJldXNlKSB7XG4gICAgcmV0dXJuIFtcbiAgICAgIHsgUGFyYW1ldGVyS2V5OiBhc3NldC5pbWFnZU5hbWVQYXJhbWV0ZXIsIFVzZVByZXZpb3VzVmFsdWU6IHRydWUgfSxcbiAgICBdO1xuICB9XG5cbiAgZGVidWcoJyDwn5GRICBQcmVwYXJpbmcgRG9ja2VyIGltYWdlIGFzc2V0OicsIGFzc2V0LnBhdGgpO1xuXG4gIGNvbnN0IGJ1aWxkSG9sZCA9IG5ldyBQbGVhc2VIb2xkKGAg4oybIEJ1aWxkaW5nIEFzc2V0IERvY2tlciBpbWFnZSAke2Fzc2V0LmlkfSBmcm9tICR7YXNzZXQucGF0aH07IHRoaXMgbWF5IHRha2UgYSB3aGlsZS5gKTtcbiAgdHJ5IHtcbiAgICBjb25zdCBlY3IgPSBhd2FpdCB0b29sa2l0SW5mby5wcmVwYXJlRWNyUmVwb3NpdG9yeShhc3NldC5pZCk7XG4gICAgY29uc3QgbGF0ZXN0ID0gYCR7ZWNyLnJlcG9zaXRvcnlVcml9OmxhdGVzdGA7XG5cbiAgICBsZXQgbG9nZ2VkSW4gPSBmYWxzZTtcblxuICAgIC8vIEluIENJIHdlIHRyeSB0byBwdWxsIGxhdGVzdCBmaXJzdFxuICAgIGlmIChjaSkge1xuICAgICAgYXdhaXQgZG9ja2VyTG9naW4odG9vbGtpdEluZm8pO1xuICAgICAgbG9nZ2VkSW4gPSB0cnVlO1xuXG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBzaGVsbChbJ2RvY2tlcicsICdwdWxsJywgbGF0ZXN0XSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGRlYnVnKCdGYWlsZWQgdG8gcHVsbCBsYXRlc3QgaW1hZ2UgZnJvbSBFQ1IgcmVwb3NpdG9yeScpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGJ1aWxkSG9sZC5zdGFydCgpO1xuXG4gICAgY29uc3QgYmFzZUNvbW1hbmQgPSBbJ2RvY2tlcicsXG4gICAgICAnYnVpbGQnLFxuICAgICAgJy0tcXVpZXQnLFxuICAgICAgYXNzZXQucGF0aF07XG4gICAgY29uc3QgY29tbWFuZCA9IGNpXG4gICAgICA/IFsuLi5iYXNlQ29tbWFuZCwgJy0tY2FjaGUtZnJvbScsIGxhdGVzdF0gLy8gVGhpcyBkb2VzIG5vdCBmYWlsIGlmIGxhdGVzdCBpcyBub3QgYXZhaWxhYmxlXG4gICAgICA6IGJhc2VDb21tYW5kO1xuICAgIGNvbnN0IGltYWdlSWQgPSAoYXdhaXQgc2hlbGwoY29tbWFuZCwgeyBxdWlldDogdHJ1ZSB9KSkudHJpbSgpO1xuXG4gICAgYnVpbGRIb2xkLnN0b3AoKTtcblxuICAgIGNvbnN0IHRhZyA9IGF3YWl0IGNhbGN1bGF0ZUltYWdlRmluZ2VycHJpbnQoaW1hZ2VJZCk7XG5cbiAgICBkZWJ1ZyhgIOKMmyAgSW1hZ2UgaGFzIHRhZyAke3RhZ30sIGNoZWNraW5nIEVDUiByZXBvc2l0b3J5YCk7XG4gICAgY29uc3QgaW1hZ2VFeGlzdHMgPSBhd2FpdCB0b29sa2l0SW5mby5jaGVja0VjckltYWdlKGVjci5yZXBvc2l0b3J5TmFtZSwgdGFnKTtcblxuICAgIGlmIChpbWFnZUV4aXN0cykge1xuICAgICAgZGVidWcoJyDwn5GRICBJbWFnZSBhbHJlYWR5IHVwbG9hZGVkLicpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBMb2dpbiBhbmQgcHVzaFxuICAgICAgZGVidWcoYCDijJsgIEltYWdlIG5lZWRzIHRvIGJlIHVwbG9hZGVkIGZpcnN0LmApO1xuXG4gICAgICBpZiAoIWxvZ2dlZEluKSB7IC8vIFdlIGNvdWxkIGJlIGFscmVhZHkgbG9nZ2VkIGluIGlmIGluIENJXG4gICAgICAgIGF3YWl0IGRvY2tlckxvZ2luKHRvb2xraXRJbmZvKTtcbiAgICAgICAgbG9nZ2VkSW4gPSB0cnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBxdWFsaWZpZWRJbWFnZU5hbWUgPSBgJHtlY3IucmVwb3NpdG9yeVVyaX06JHt0YWd9YDtcblxuICAgICAgYXdhaXQgc2hlbGwoWydkb2NrZXInLCAndGFnJywgaW1hZ2VJZCwgcXVhbGlmaWVkSW1hZ2VOYW1lXSk7XG5cbiAgICAgIC8vIFRoZXJlJ3Mgbm8gd2F5IHRvIG1ha2UgdGhpcyBxdWlldCwgc28gd2UgY2FuJ3QgdXNlIGEgUGxlYXNlSG9sZC4gUHJpbnQgYSBoZWFkZXIgbWVzc2FnZS5cbiAgICAgIHByaW50KGAg4oybIFB1c2hpbmcgRG9ja2VyIGltYWdlIGZvciAke2Fzc2V0LnBhdGh9OyB0aGlzIG1heSB0YWtlIGEgd2hpbGUuYCk7XG4gICAgICBhd2FpdCBzaGVsbChbJ2RvY2tlcicsICdwdXNoJywgcXVhbGlmaWVkSW1hZ2VOYW1lXSk7XG4gICAgICBkZWJ1ZyhgIPCfkZEgIERvY2tlciBpbWFnZSBmb3IgJHthc3NldC5wYXRofSBwdXNoZWQuYCk7XG4gICAgfVxuXG4gICAgaWYgKCFsb2dnZWRJbikgeyAvLyBXZSBjb3VsZCBiZSBhbHJlYWR5IGxvZ2dlZCBpbiBpZiBpbiBDSSBvciBpZiBpbWFnZSBkaWQgbm90IGV4aXN0XG4gICAgICBhd2FpdCBkb2NrZXJMb2dpbih0b29sa2l0SW5mbyk7XG4gICAgfVxuXG4gICAgLy8gQWx3YXlzIHRhZyBhbmQgcHVzaCBsYXRlc3RcbiAgICBhd2FpdCBzaGVsbChbJ2RvY2tlcicsICd0YWcnLCBpbWFnZUlkLCBsYXRlc3RdKTtcbiAgICBhd2FpdCBzaGVsbChbJ2RvY2tlcicsICdwdXNoJywgbGF0ZXN0XSk7XG5cbiAgICByZXR1cm4gW1xuICAgICAgeyBQYXJhbWV0ZXJLZXk6IGFzc2V0LmltYWdlTmFtZVBhcmFtZXRlciwgUGFyYW1ldGVyVmFsdWU6IGAke2Vjci5yZXBvc2l0b3J5TmFtZX06JHt0YWd9YCB9LFxuICAgIF07XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoZS5jb2RlID09PSAnRU5PRU5UJykge1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdFcnJvciBidWlsZGluZyBEb2NrZXIgaW1hZ2UgYXNzZXQ7IHlvdSBuZWVkIHRvIGhhdmUgRG9ja2VyIGluc3RhbGxlZCBpbiBvcmRlciB0byBiZSBhYmxlIHRvIGJ1aWxkIGltYWdlIGFzc2V0cy4gUGxlYXNlIGluc3RhbGwgRG9ja2VyIGFuZCB0cnkgYWdhaW4uJyk7XG4gICAgfVxuICAgIHRocm93IGU7XG4gIH0gZmluYWxseSB7XG4gICAgYnVpbGRIb2xkLnN0b3AoKTtcbiAgfVxufVxuXG4vKipcbiAqIEdldCBjcmVkZW50aWFscyBmcm9tIEVDUiBhbmQgcnVuIGRvY2tlciBsb2dpblxuICovXG5hc3luYyBmdW5jdGlvbiBkb2NrZXJMb2dpbih0b29sa2l0SW5mbzogVG9vbGtpdEluZm8pIHtcbiAgY29uc3QgY3JlZGVudGlhbHMgPSBhd2FpdCB0b29sa2l0SW5mby5nZXRFY3JDcmVkZW50aWFscygpO1xuICBhd2FpdCBzaGVsbChbJ2RvY2tlcicsICdsb2dpbicsXG4gICctLXVzZXJuYW1lJywgY3JlZGVudGlhbHMudXNlcm5hbWUsXG4gICctLXBhc3N3b3JkJywgY3JlZGVudGlhbHMucGFzc3dvcmQsXG4gIGNyZWRlbnRpYWxzLmVuZHBvaW50XSk7XG59XG5cbi8qKlxuICogQ2FsY3VsYXRlIGltYWdlIGZpbmdlcnByaW50LlxuICpcbiAqIFRoZSBmaW5nZXJwcmludCBoYXMgYSBoaWdoIGxpa2VsaWhvb2QgdG8gYmUgdGhlIHNhbWUgYWNyb3NzIHJlcG9zaXRvcmllcy5cbiAqIChBcyBvcHBvc2VkIHRvIERvY2tlcidzIGJ1aWx0LWluIGltYWdlIGRpZ2VzdCwgd2hpY2ggY2hhbmdlcyBhcyBzb29uXG4gKiBhcyB0aGUgaW1hZ2UgaXMgdXBsb2FkZWQgc2luY2UgaXQgaW5jbHVkZXMgdGhlIHRhZ3MgdGhhdCBhbiBpbWFnZSBoYXMpLlxuICpcbiAqIFRoZSBmaW5nZXJwcmludCB3aWxsIGJlIHVzZWQgYXMgYSB0YWcgdG8gaWRlbnRpZnkgYSBwYXJ0aWN1bGFyIGltYWdlLlxuICovXG5hc3luYyBmdW5jdGlvbiBjYWxjdWxhdGVJbWFnZUZpbmdlcnByaW50KGltYWdlSWQ6IHN0cmluZykge1xuICBjb25zdCBtYW5pZmVzdFN0cmluZyA9IGF3YWl0IHNoZWxsKFsnZG9ja2VyJywgJ2luc3BlY3QnLCBpbWFnZUlkXSwgeyBxdWlldDogdHJ1ZSB9KTtcbiAgY29uc3QgbWFuaWZlc3QgPSBKU09OLnBhcnNlKG1hbmlmZXN0U3RyaW5nKVswXTtcblxuICAvLyBJZCBjYW4gY2hhbmdlXG4gIGRlbGV0ZSBtYW5pZmVzdC5JZDtcblxuICAvLyBSZXBvc2l0b3J5LWJhc2VkIGlkZW50aWZpZXJzIGFyZSBvdXRcbiAgZGVsZXRlIG1hbmlmZXN0LlJlcG9UYWdzO1xuICBkZWxldGUgbWFuaWZlc3QuUmVwb0RpZ2VzdHM7XG5cbiAgLy8gTWV0YWRhdGEgdGhhdCBoYXMgbm8gYmVhcmluZyBvbiB0aGUgaW1hZ2UgY29udGVudHNcbiAgZGVsZXRlIG1hbmlmZXN0LkNyZWF0ZWQ7XG5cbiAgLy8gV2UncmUgaW50ZXJlc3RlZCBpbiB0aGUgaW1hZ2UgaXRzZWxmLCBub3QgYW55IHJ1bm5pbmcgaW5zdGFjZXMgb2YgaXRcbiAgZGVsZXRlIG1hbmlmZXN0LkNvbnRhaW5lcjtcbiAgZGVsZXRlIG1hbmlmZXN0LkNvbnRhaW5lckNvbmZpZztcblxuICAvLyBXZSdyZSBub3QgaW50ZXJlc3RlZCBpbiB0aGUgRG9ja2VyIHZlcnNpb24gdXNlZCB0byBjcmVhdGUgdGhpcyBpbWFnZVxuICBkZWxldGUgbWFuaWZlc3QuRG9ja2VyVmVyc2lvbjtcblxuICAvLyBPbiBzb21lIERvY2tlciB2ZXJzaW9ucyBNZXRhZGF0YSBjb250YWlucyBhIExhc3RUYWdUaW1lIHdoaWNoIHVwZGF0ZXNcbiAgLy8gb24gZXZlcnkgcHVzaCwgY2F1c2luZyB1cyB0byBtaXNzIGFsbCBjYWNoZSBoaXRzLlxuICBkZWxldGUgbWFuaWZlc3QuTWV0YWRhdGE7XG5cbiAgLy8gR3JhcGhEcml2ZXIgaXMgYWJvdXQgcnVubmluZyB0aGUgaW1hZ2UsIG5vdCBhYm91dCB0aGUgaW1hZ2UgaXRzZWxmLlxuICBkZWxldGUgbWFuaWZlc3QuR3JhcGhEcml2ZXI7XG5cbiAgcmV0dXJuIGNyeXB0by5jcmVhdGVIYXNoKCdzaGEyNTYnKS51cGRhdGUoSlNPTi5zdHJpbmdpZnkobWFuaWZlc3QpKS5kaWdlc3QoJ2hleCcpO1xufVxuXG4vKipcbiAqIEV4YW1wbGUgb2YgYSBEb2NrZXIgbWFuaWZlc3RcbiAqXG4gKiBbXG4gKiAgICAge1xuICogICAgICAgICBcIklkXCI6IFwic2hhMjU2OjNhOTA1NDI5OTFkMDMwMDdmZDFkOGYzYjNhNmFiMDRlYmIwMjM4Njc4NTQzMGZlNDhhODY3NzY4YTA0OGQ4MjhcIixcbiAqICAgICAgICAgXCJSZXBvVGFnc1wiOiBbXG4gKiAgICAgICAgICAgICBcIjk5MzY1NTc1NDM1OS5ka3IuZWNyLnVzLWVhc3QtMS5hbWF6b25hd3MuY29tL2Nkay9hd3NlY3NpbnRlZ2ltYWdlN2MxNWI4YzY6bGF0ZXN0XCJcbiAqICAgICAgICAgXSxcbiAqICAgICAgICAgXCJSZXBvRGlnZXN0c1wiOiBbXG4gKiAgICAgICAgICAgICBcIjk5MzY1NTc1NDM1OS5ka3IuZWNyLnVzLWVhc3QtMS5hbWF6by4uLi41ZTUwYzBjZmMzZjIzNTUxOTE5MzRiMDVkZjY4Y2QzMzM5YTA0NDk1OTExMWZmZWMyZTE0NzY1XCJcbiAqICAgICAgICAgXSxcbiAqICAgICAgICAgXCJQYXJlbnRcIjogXCJzaGEyNTY6NDY1NzIwZjhmNDNjOWMwYWZmNWRjYzczMWQ0ZTM2OGEzOTI3Y2FlNGU4ODU0NDJkNGJhMGJmOGE4NjdiNzU2MVwiLFxuICogICAgICAgICBcIkNvbW1lbnRcIjogXCJcIixcbiAqICAgICAgICAgXCJDcmVhdGVkXCI6IFwiMjAxOC0xMC0xN1QxMDoxNjo0MC43NzU4ODg0NzZaXCIsXG4gKiAgICAgICAgIFwiQ29udGFpbmVyXCI6IFwiMjBmMTQ1ZDJlN2ZiZjEyNmNhOWY0NDIyNDk3YjkzMmJjOTZiNWZhYTAzOGRjMDMyZGUxZTI0NmY2NGUwM2E2NlwiLFxuICogICAgICAgICBcIkNvbnRhaW5lckNvbmZpZ1wiOiB7XG4gKiAgICAgICAgICAgICBcIkhvc3RuYW1lXCI6IFwiOWI0OGI1ODBhMzEyXCIsXG4gKiAgICAgICAgICAgICBcIkRvbWFpbm5hbWVcIjogXCJcIixcbiAqICAgICAgICAgICAgIFwiVXNlclwiOiBcIlwiLFxuICogICAgICAgICAgICAgXCJBdHRhY2hTdGRpblwiOiBmYWxzZSxcbiAqICAgICAgICAgICAgIFwiQXR0YWNoU3Rkb3V0XCI6IGZhbHNlLFxuICogICAgICAgICAgICAgXCJBdHRhY2hTdGRlcnJcIjogZmFsc2UsXG4gKiAgICAgICAgICAgICBcIkV4cG9zZWRQb3J0c1wiOiB7XG4gKiAgICAgICAgICAgICAgICAgXCI4MDAwL3RjcFwiOiB7fVxuICogICAgICAgICAgICAgfSxcbiAqICAgICAgICAgICAgIFwiVHR5XCI6IGZhbHNlLFxuICogICAgICAgICAgICAgXCJPcGVuU3RkaW5cIjogZmFsc2UsXG4gKiAgICAgICAgICAgICBcIlN0ZGluT25jZVwiOiBmYWxzZSxcbiAqICAgICAgICAgICAgIFwiRW52XCI6IFtcbiAqICAgICAgICAgICAgICAgICBcIlBBVEg9L3Vzci9sb2NhbC9iaW46L3Vzci9sb2NhbC9zYmluOi91c3IvbG9jYWwvYmluOi91c3Ivc2JpbjovdXNyL2Jpbjovc2JpbjovYmluXCIsXG4gKiAgICAgICAgICAgICAgICAgXCJMQU5HPUMuVVRGLThcIixcbiAqICAgICAgICAgICAgICAgICBcIkdQR19LRVk9MEQ5NkRGNEQ0MTEwRTVDNDNGQkZCMTdGMkQzNDdFQTZBQTY1NDIxRFwiLFxuICogICAgICAgICAgICAgICAgIFwiUFlUSE9OX1ZFUlNJT049My42LjZcIixcbiAqICAgICAgICAgICAgICAgICBcIlBZVEhPTl9QSVBfVkVSU0lPTj0xOC4xXCJcbiAqICAgICAgICAgICAgIF0sXG4gKiAgICAgICAgICAgICBcIkNtZFwiOiBbXG4gKiAgICAgICAgICAgICAgICAgXCIvYmluL3NoXCIsXG4gKiAgICAgICAgICAgICAgICAgXCItY1wiLFxuICogICAgICAgICAgICAgICAgIFwiIyhub3ApIFwiLFxuICogICAgICAgICAgICAgICAgIFwiQ01EIFtcXFwiL2Jpbi9zaFxcXCIgXFxcIi1jXFxcIiBcXFwicHl0aG9uMyBpbmRleC5weVxcXCJdXCJcbiAqICAgICAgICAgICAgIF0sXG4gKiAgICAgICAgICAgICBcIkFyZ3NFc2NhcGVkXCI6IHRydWUsXG4gKiAgICAgICAgICAgICBcIkltYWdlXCI6IFwic2hhMjU2OjQ2NTcyMGY4ZjQzYzljMGFmZjVkY2M3MzFkNGUzNjhhMzkyN2NhZTRlODg1NDQyZDRiYTBiZjhhODY3Yjc1NjFcIixcbiAqICAgICAgICAgICAgIFwiVm9sdW1lc1wiOiBudWxsLFxuICogICAgICAgICAgICAgXCJXb3JraW5nRGlyXCI6IFwiL2NvZGVcIixcbiAqICAgICAgICAgICAgIFwiRW50cnlwb2ludFwiOiBudWxsLFxuICogICAgICAgICAgICAgXCJPbkJ1aWxkXCI6IFtdLFxuICogICAgICAgICAgICAgXCJMYWJlbHNcIjoge31cbiAqICAgICAgICAgfSxcbiAqICAgICAgICAgXCJEb2NrZXJWZXJzaW9uXCI6IFwiMTcuMDMuMi1jZVwiLFxuICogICAgICAgICBcIkF1dGhvclwiOiBcIlwiLFxuICogICAgICAgICBcIkNvbmZpZ1wiOiB7XG4gKiAgICAgICAgICAgICBcIkhvc3RuYW1lXCI6IFwiOWI0OGI1ODBhMzEyXCIsXG4gKiAgICAgICAgICAgICBcIkRvbWFpbm5hbWVcIjogXCJcIixcbiAqICAgICAgICAgICAgIFwiVXNlclwiOiBcIlwiLFxuICogICAgICAgICAgICAgXCJBdHRhY2hTdGRpblwiOiBmYWxzZSxcbiAqICAgICAgICAgICAgIFwiQXR0YWNoU3Rkb3V0XCI6IGZhbHNlLFxuICogICAgICAgICAgICAgXCJBdHRhY2hTdGRlcnJcIjogZmFsc2UsXG4gKiAgICAgICAgICAgICBcIkV4cG9zZWRQb3J0c1wiOiB7XG4gKiAgICAgICAgICAgICAgICAgXCI4MDAwL3RjcFwiOiB7fVxuICogICAgICAgICAgICAgfSxcbiAqICAgICAgICAgICAgIFwiVHR5XCI6IGZhbHNlLFxuICogICAgICAgICAgICAgXCJPcGVuU3RkaW5cIjogZmFsc2UsXG4gKiAgICAgICAgICAgICBcIlN0ZGluT25jZVwiOiBmYWxzZSxcbiAqICAgICAgICAgICAgIFwiRW52XCI6IFtcbiAqICAgICAgICAgICAgICAgICBcIlBBVEg9L3Vzci9sb2NhbC9iaW46L3Vzci9sb2NhbC9zYmluOi91c3IvbG9jYWwvYmluOi91c3Ivc2JpbjovdXNyL2Jpbjovc2JpbjovYmluXCIsXG4gKiAgICAgICAgICAgICAgICAgXCJMQU5HPUMuVVRGLThcIixcbiAqICAgICAgICAgICAgICAgICBcIkdQR19LRVk9MEQ5NkRGNEQ0MTEwRTVDNDNGQkZCMTdGMkQzNDdFQTZBQTY1NDIxRFwiLFxuICogICAgICAgICAgICAgICAgIFwiUFlUSE9OX1ZFUlNJT049My42LjZcIixcbiAqICAgICAgICAgICAgICAgICBcIlBZVEhPTl9QSVBfVkVSU0lPTj0xOC4xXCJcbiAqICAgICAgICAgICAgIF0sXG4gKiAgICAgICAgICAgICBcIkNtZFwiOiBbXG4gKiAgICAgICAgICAgICAgICAgXCIvYmluL3NoXCIsXG4gKiAgICAgICAgICAgICAgICAgXCItY1wiLFxuICogICAgICAgICAgICAgICAgIFwicHl0aG9uMyBpbmRleC5weVwiXG4gKiAgICAgICAgICAgICBdLFxuICogICAgICAgICAgICAgXCJBcmdzRXNjYXBlZFwiOiB0cnVlLFxuICogICAgICAgICAgICAgXCJJbWFnZVwiOiBcInNoYTI1Njo0NjU3MjBmOGY0M2M5YzBhZmY1ZGNjNzMxZDRlMzY4YTM5MjdjYWU0ZTg4NTQ0MmQ0YmEwYmY4YTg2N2I3NTYxXCIsXG4gKiAgICAgICAgICAgICBcIlZvbHVtZXNcIjogbnVsbCxcbiAqICAgICAgICAgICAgIFwiV29ya2luZ0RpclwiOiBcIi9jb2RlXCIsXG4gKiAgICAgICAgICAgICBcIkVudHJ5cG9pbnRcIjogbnVsbCxcbiAqICAgICAgICAgICAgIFwiT25CdWlsZFwiOiBbXSxcbiAqICAgICAgICAgICAgIFwiTGFiZWxzXCI6IHt9XG4gKiAgICAgICAgIH0sXG4gKiAgICAgICAgIFwiQXJjaGl0ZWN0dXJlXCI6IFwiYW1kNjRcIixcbiAqICAgICAgICAgXCJPc1wiOiBcImxpbnV4XCIsXG4gKiAgICAgICAgIFwiU2l6ZVwiOiA5MTc3MzA0NjgsXG4gKiAgICAgICAgIFwiVmlydHVhbFNpemVcIjogOTE3NzMwNDY4LFxuICogICAgICAgICBcIkdyYXBoRHJpdmVyXCI6IHtcbiAqICAgICAgICAgICAgIFwiTmFtZVwiOiBcImF1ZnNcIixcbiAqICAgICAgICAgICAgIFwiRGF0YVwiOiBudWxsXG4gKiAgICAgICAgIH0sXG4gKiAgICAgICAgIFwiUm9vdEZTXCI6IHtcbiAqICAgICAgICAgICAgIFwiVHlwZVwiOiBcImxheWVyc1wiLFxuICogICAgICAgICAgICAgXCJMYXllcnNcIjogW1xuICogICAgICAgICAgICAgICAgIFwic2hhMjU2OmY3MTVlZDE5YzI4YjY2OTQzYWM4YmMxMmRiZmI4MjhlODM5NGRlMjUzMGJiYWYxZWNjZTkwNmU3NDhlNGZkZmZcIixcbiAqICAgICAgICAgICAgICAgICBcInNoYTI1Njo4YmIyNWY5Y2RjNDFlN2QwODUwMzNhZjE1YTUyMjk3M2I0NDA4NmQ2ZWVkZDI0YzExY2M2MWM5MjMyMzI0Zjc3XCIsXG4gKiAgICAgICAgICAgICAgICAgXCJzaGEyNTY6MDhhMDE2MTJmZmNhMzM0ODNhMTg0N2M5MDk4MzY2MTA2MTBjZTUyM2ZiN2UxYWNhODgwMTQwZWU4NGRmMjNlOVwiLFxuICogICAgICAgICAgICAgICAgIFwic2hhMjU2OjExOTFiM2Y1ODYyYWE5MjMxODU4ODA5YjdhYzhiOTFjMGI3MjdjZTg1YzliMzI3OTkzMmYwYmFhY2M5Mjk2N2RcIixcbiAqICAgICAgICAgICAgICAgICBcInNoYTI1Njo5OTc4ZDA4NGZkNzcxZTBiM2QxYWNkN2YzNTI1ZDFiMjUyODhhYmFiZTlhZDhlZDI1OWIzNjEwMWU0ZTNhZGRkXCIsXG4gKiAgICAgICAgICAgICAgICAgXCJzaGEyNTY6MmY0Zjc0ZDM4MjFlY2JkZDYwYjVkOTMyNDUyZWE5ZTMwY2VjZjkwMjMzNDE2NWM0YTE5ODM3ZjZlZTYzNjM3N1wiLFxuICogICAgICAgICAgICAgICAgIFwic2hhMjU2OjAwM2JiNjE3OGJjMzIxODI0MmQ3M2U1MWQ1ZTlhYjJmOTkxZGM2MDc3ODAxOTQ3MTljNmJkNGM4YzQxMmZlOGNcIixcbiAqICAgICAgICAgICAgICAgICBcInNoYTI1NjoxNWIzMmQ4NDlkYTIyMzliMWFmNTgzZjkzODFjN2E3NWQ3YWNlYmExMmY1ZGRmZmZhN2EwNTkxMTZjZjA1YWI5XCIsXG4gKiAgICAgICAgICAgICAgICAgXCJzaGEyNTY6NmU1YzVmNmJmMDQzYmM2MzQzNzhiMWU0YjYxYWYwOWJlNzQ3NDFmMmFjODAyMDRkN2EzNzM3MTNiMWZkNWE0MFwiLFxuICogICAgICAgICAgICAgICAgIFwic2hhMjU2OjMyNjBlMDBlMzUzYmZiNzY1YjI1NTk3ZDEzODY4YzJlZjY0Y2IzZDUwOTg3NWFiY2ZiNThjNGU5YmY3ZjRlZTJcIixcbiAqICAgICAgICAgICAgICAgICBcInNoYTI1NjpmMzI3NGI3NTg1NjMxMWU5MmUxNGExMjcwYzc4NzM3Yzg2NDU2ZDYzNTNmZTRhODNiZDJlODFiY2QyYTk5NmVhXCJcbiAqICAgICAgICAgICAgIF1cbiAqICAgICAgICAgfVxuICogICAgIH1cbiAqIF1cbiAqL1xuIl19