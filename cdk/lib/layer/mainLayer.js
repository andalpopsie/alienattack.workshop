"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const resourceawarestack_1 = require("../resourceawarestack");
const securityLayer_1 = require("./securityLayer");
const configurationLayer_1 = require("./configurationLayer");
const storageLayer_1 = require("./storageLayer");
const databaseLayer_1 = require("./databaseLayer");
const ingestionConsumptionLayer_1 = require("./ingestionConsumptionLayer");
const processingLayer_1 = require("./processingLayer");
class MainLayer extends resourceawarestack_1.ResourceAwareStack {
    constructor(scope, id, props) {
        super(scope, id, props);
        this.buildResources();
    }
    buildResources() {
        // security layer
        let securityLayer = new securityLayer_1.SecurityLayer(this, 'SecurityLayer', this.properties);
        // configuration layer
        let configLayerProps = new resourceawarestack_1.ParameterAwareProps(this.properties);
        let ssmProperties = new Map();
        ssmProperties.set("Region", this.region);
        ssmProperties.set("ClientId", securityLayer.getUserPoolClientId());
        ssmProperties.set("UserpoolId", securityLayer.getUserPoolId());
        ssmProperties.set("UserPoolURL", securityLayer.getUserPoolUrl());
        ssmProperties.set("IdentityPoolId", securityLayer.getIdentityPoolId());
        // MISSING PARAMETER
        // ssmProperties.set("Session", "null");
        configLayerProps.addParameter('ssmParameters', ssmProperties);
        // MISSING PARAMETER  - side effect - uncomment the next line to fix it
        // let configLayer =
        new configurationLayer_1.ConfigurationLayer(this, 'ConfigurationLayer', configLayerProps);
        // storage layer
        let storageLayer = new storageLayer_1.StorageLayer(this, 'StorageStorage', this.properties);
        // UNCOMMENT the following section if you want to have the CDN created. It will take 20 minutes to build/destroy
        /*
        let cdnLayerProps = new ParameterAwareProps(this.properties);
        cdnLayerProps.addParameter('appbucket',storageLayer.getResource('appbucket'));
          new ContentDeliveryLayer(this,'ContentDeliveryLayer',cdnLayerProps);
          */
        // database layer
        let databaseLayer = new databaseLayer_1.DatabaseLayer(this, 'DatabaseLayer', this.properties);
        // processing layer
        let processingLayerProps = new resourceawarestack_1.ParameterAwareProps(this.properties);
        // MISSING PARAMETER - side effect - uncomment the next line
        // processingLayerProps.addParameter('parameter.session', configLayer.getResource('parameter.session'));
        processingLayerProps.addParameter('table.sessionControl', databaseLayer.getResource('table.sessionControl'));
        processingLayerProps.addParameter('table.sessionTopX', databaseLayer.getResource('table.sessionTopX'));
        processingLayerProps.addParameter('table.session', databaseLayer.getResource('table.session'));
        let processingLayer = new processingLayer_1.ProcessingLayer(this, 'ProcessingLayer', processingLayerProps);
        // Ingestion/consumption layer
        let ingestionConsumptionLayerProps = new resourceawarestack_1.ParameterAwareProps(processingLayerProps);
        ingestionConsumptionLayerProps.addParameter('rawbucketarn', storageLayer.getRawDataBucketArn());
        ingestionConsumptionLayerProps.addParameter('userpool', securityLayer.getUserPoolArn());
        ingestionConsumptionLayerProps.addParameter('userpoolid', securityLayer.getUserPoolId());
        ingestionConsumptionLayerProps.addParameter('table.session', databaseLayer.getResource('table.session'));
        ingestionConsumptionLayerProps.addParameter('table.sessiontopx', databaseLayer.getResource('table.sessiontopx'));
        ingestionConsumptionLayerProps.addParameter('lambda.allocate', processingLayer.getAllocateFunctionRef());
        ingestionConsumptionLayerProps.addParameter('lambda.deallocate', processingLayer.getDeallocateFunctionArn());
        ingestionConsumptionLayerProps.addParameter('lambda.scoreboard', processingLayer.getScoreboardFunctionRef());
        ingestionConsumptionLayerProps.addParameter('security.playersrole', securityLayer.getResource('security.playersrole'));
        ingestionConsumptionLayerProps.addParameter('security.managersrole', securityLayer.getResource('security.managersrole'));
        new ingestionConsumptionLayer_1.IngestionConsumptionLayer(this, 'IngestionConsumptionLayer', ingestionConsumptionLayerProps);
    }
}
exports.MainLayer = MainLayer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbkxheWVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibWFpbkxheWVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsOERBQXFHO0FBRXJHLG1EQUFnRDtBQUNoRCw2REFBMEQ7QUFDMUQsaURBQThDO0FBQzlDLG1EQUFnRDtBQUNoRCwyRUFBd0U7QUFDeEUsdURBQW9EO0FBSXBELE1BQWEsU0FBVSxTQUFRLHVDQUFrQjtJQUUvQyxZQUFZLEtBQVUsRUFBRSxFQUFVLEVBQUUsS0FBNEI7UUFDOUQsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDeEIsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQ3hCLENBQUM7SUFFRCxjQUFjO1FBRVosaUJBQWlCO1FBQ2pCLElBQUksYUFBYSxHQUNmLElBQUksNkJBQWEsQ0FBQyxJQUFJLEVBQUUsZUFBZSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUU1RCxzQkFBc0I7UUFDdEIsSUFBSSxnQkFBZ0IsR0FBRyxJQUFJLHdDQUFtQixDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUVoRSxJQUFJLGFBQWEsR0FBRyxJQUFJLEdBQUcsRUFBaUIsQ0FBQztRQUM3QyxhQUFhLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDekMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsYUFBYSxDQUFDLG1CQUFtQixFQUFFLENBQUMsQ0FBQztRQUNuRSxhQUFhLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxhQUFhLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQztRQUMvRCxhQUFhLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxhQUFhLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQztRQUNqRSxhQUFhLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLGFBQWEsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLENBQUM7UUFDdkUsb0JBQW9CO1FBQ3BCLHdDQUF3QztRQUN4QyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsZUFBZSxFQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQzdELHVFQUF1RTtRQUN4RSxvQkFBb0I7UUFDakIsSUFBSSx1Q0FBa0IsQ0FBQyxJQUFJLEVBQUUsb0JBQW9CLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztRQUV2RSxnQkFBZ0I7UUFDaEIsSUFBSSxZQUFZLEdBQ2QsSUFBSSwyQkFBWSxDQUFDLElBQUksRUFBRSxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFHNUQsZ0hBQWdIO1FBQ2hIOzs7O1lBSUk7UUFHSixpQkFBaUI7UUFDakIsSUFBSSxhQUFhLEdBQ2YsSUFBSSw2QkFBYSxDQUFDLElBQUksRUFBRSxlQUFlLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRTVELG1CQUFtQjtRQUNuQixJQUFJLG9CQUFvQixHQUFHLElBQUksd0NBQW1CLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3BFLDREQUE0RDtRQUM1RCx3R0FBd0c7UUFDdEcsb0JBQW9CLENBQUMsWUFBWSxDQUFDLHNCQUFzQixFQUFFLGFBQWEsQ0FBQyxXQUFXLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxDQUFDO1FBQzdHLG9CQUFvQixDQUFDLFlBQVksQ0FBQyxtQkFBbUIsRUFBRSxhQUFhLENBQUMsV0FBVyxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQztRQUN2RyxvQkFBb0IsQ0FBQyxZQUFZLENBQUMsZUFBZSxFQUFFLGFBQWEsQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztRQUNqRyxJQUFJLGVBQWUsR0FBRyxJQUFJLGlDQUFlLENBQUMsSUFBSSxFQUFFLGlCQUFpQixFQUFFLG9CQUFvQixDQUFDLENBQUM7UUFFekYsOEJBQThCO1FBQzlCLElBQUksOEJBQThCLEdBQUcsSUFBSSx3Q0FBbUIsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1FBQ25GLDhCQUE4QixDQUFDLFlBQVksQ0FBQyxjQUFjLEVBQUUsWUFBWSxDQUFDLG1CQUFtQixFQUFFLENBQUMsQ0FBQztRQUNoRyw4QkFBOEIsQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFDLGFBQWEsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDO1FBQ3ZGLDhCQUE4QixDQUFDLFlBQVksQ0FBQyxZQUFZLEVBQUUsYUFBYSxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQUM7UUFDekYsOEJBQThCLENBQUMsWUFBWSxDQUFDLGVBQWUsRUFBQyxhQUFhLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7UUFDeEcsOEJBQThCLENBQUMsWUFBWSxDQUFDLG1CQUFtQixFQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDO1FBQ2hILDhCQUE4QixDQUFDLFlBQVksQ0FBQyxpQkFBaUIsRUFBQyxlQUFlLENBQUMsc0JBQXNCLEVBQUUsQ0FBQyxDQUFDO1FBQ3hHLDhCQUE4QixDQUFDLFlBQVksQ0FBQyxtQkFBbUIsRUFBQyxlQUFlLENBQUMsd0JBQXdCLEVBQUUsQ0FBQyxDQUFDO1FBQzVHLDhCQUE4QixDQUFDLFlBQVksQ0FBQyxtQkFBbUIsRUFBQyxlQUFlLENBQUMsd0JBQXdCLEVBQUUsQ0FBQyxDQUFDO1FBQzVHLDhCQUE4QixDQUFDLFlBQVksQ0FBQyxzQkFBc0IsRUFBRSxhQUFhLENBQUMsV0FBVyxDQUFDLHNCQUFzQixDQUFDLENBQUMsQ0FBQztRQUN2SCw4QkFBOEIsQ0FBQyxZQUFZLENBQUMsdUJBQXVCLEVBQUUsYUFBYSxDQUFDLFdBQVcsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLENBQUM7UUFDekgsSUFBSSxxREFBeUIsQ0FBQyxJQUFJLEVBQUUsMkJBQTJCLEVBQUMsOEJBQThCLENBQUMsQ0FBQztJQUNsRyxDQUFDO0NBQ0Y7QUFyRUQsOEJBcUVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwIH0gZnJvbSAnQGF3cy1jZGsvY2RrJztcbmltcG9ydCB7IElQYXJhbWV0ZXJBd2FyZVByb3BzLCBQYXJhbWV0ZXJBd2FyZVByb3BzLCBSZXNvdXJjZUF3YXJlU3RhY2t9IGZyb20gJy4uL3Jlc291cmNlYXdhcmVzdGFjayc7XG5cbmltcG9ydCB7IFNlY3VyaXR5TGF5ZXIgfSBmcm9tICcuL3NlY3VyaXR5TGF5ZXInO1xuaW1wb3J0IHsgQ29uZmlndXJhdGlvbkxheWVyIH0gZnJvbSAnLi9jb25maWd1cmF0aW9uTGF5ZXInO1xuaW1wb3J0IHsgU3RvcmFnZUxheWVyIH0gZnJvbSAnLi9zdG9yYWdlTGF5ZXInO1xuaW1wb3J0IHsgRGF0YWJhc2VMYXllciB9IGZyb20gJy4vZGF0YWJhc2VMYXllcic7XG5pbXBvcnQgeyBJbmdlc3Rpb25Db25zdW1wdGlvbkxheWVyIH0gZnJvbSAnLi9pbmdlc3Rpb25Db25zdW1wdGlvbkxheWVyJztcbmltcG9ydCB7IFByb2Nlc3NpbmdMYXllciB9IGZyb20gJy4vcHJvY2Vzc2luZ0xheWVyJztcbmltcG9ydCB7IENvbnRlbnREZWxpdmVyeUxheWVyIH0gZnJvbSAnLi9jb250ZW50RGVsaXZlcnlMYXllcic7XG5cblxuZXhwb3J0IGNsYXNzIE1haW5MYXllciBleHRlbmRzIFJlc291cmNlQXdhcmVTdGFjayAge1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBBcHAsIGlkOiBzdHJpbmcsIHByb3BzPzogSVBhcmFtZXRlckF3YXJlUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcbiAgICB0aGlzLmJ1aWxkUmVzb3VyY2VzKCk7XG4gIH1cblxuICBidWlsZFJlc291cmNlcygpIHtcblxuICAgIC8vIHNlY3VyaXR5IGxheWVyXG4gICAgbGV0IHNlY3VyaXR5TGF5ZXIgPVxuICAgICAgbmV3IFNlY3VyaXR5TGF5ZXIodGhpcywgJ1NlY3VyaXR5TGF5ZXInLCB0aGlzLnByb3BlcnRpZXMpO1xuICAgIFxuICAgIC8vIGNvbmZpZ3VyYXRpb24gbGF5ZXJcbiAgICBsZXQgY29uZmlnTGF5ZXJQcm9wcyA9IG5ldyBQYXJhbWV0ZXJBd2FyZVByb3BzKHRoaXMucHJvcGVydGllcyk7XG4gICAgXG4gICAgbGV0IHNzbVByb3BlcnRpZXMgPSBuZXcgTWFwPHN0cmluZyxzdHJpbmc+KCk7XG4gICAgc3NtUHJvcGVydGllcy5zZXQoXCJSZWdpb25cIiwgdGhpcy5yZWdpb24pO1xuICAgIHNzbVByb3BlcnRpZXMuc2V0KFwiQ2xpZW50SWRcIiwgc2VjdXJpdHlMYXllci5nZXRVc2VyUG9vbENsaWVudElkKCkpO1xuICAgIHNzbVByb3BlcnRpZXMuc2V0KFwiVXNlcnBvb2xJZFwiLCBzZWN1cml0eUxheWVyLmdldFVzZXJQb29sSWQoKSk7XG4gICAgc3NtUHJvcGVydGllcy5zZXQoXCJVc2VyUG9vbFVSTFwiLCBzZWN1cml0eUxheWVyLmdldFVzZXJQb29sVXJsKCkpO1xuICAgIHNzbVByb3BlcnRpZXMuc2V0KFwiSWRlbnRpdHlQb29sSWRcIiwgc2VjdXJpdHlMYXllci5nZXRJZGVudGl0eVBvb2xJZCgpKTtcbiAgICAvLyBNSVNTSU5HIFBBUkFNRVRFUlxuICAgIC8vIHNzbVByb3BlcnRpZXMuc2V0KFwiU2Vzc2lvblwiLCBcIm51bGxcIik7XG4gICAgY29uZmlnTGF5ZXJQcm9wcy5hZGRQYXJhbWV0ZXIoJ3NzbVBhcmFtZXRlcnMnLHNzbVByb3BlcnRpZXMpO1xuICAgIC8vIE1JU1NJTkcgUEFSQU1FVEVSICAtIHNpZGUgZWZmZWN0IC0gdW5jb21tZW50IHRoZSBuZXh0IGxpbmUgdG8gZml4IGl0XG4gICAvLyBsZXQgY29uZmlnTGF5ZXIgPVxuICAgICAgbmV3IENvbmZpZ3VyYXRpb25MYXllcih0aGlzLCAnQ29uZmlndXJhdGlvbkxheWVyJywgY29uZmlnTGF5ZXJQcm9wcyk7XG5cbiAgICAvLyBzdG9yYWdlIGxheWVyXG4gICAgbGV0IHN0b3JhZ2VMYXllciA9XG4gICAgICBuZXcgU3RvcmFnZUxheWVyKHRoaXMsICdTdG9yYWdlU3RvcmFnZScsIHRoaXMucHJvcGVydGllcyk7XG5cblxuICAgIC8vIFVOQ09NTUVOVCB0aGUgZm9sbG93aW5nIHNlY3Rpb24gaWYgeW91IHdhbnQgdG8gaGF2ZSB0aGUgQ0ROIGNyZWF0ZWQuIEl0IHdpbGwgdGFrZSAyMCBtaW51dGVzIHRvIGJ1aWxkL2Rlc3Ryb3lcbiAgICAvKlxuICAgIGxldCBjZG5MYXllclByb3BzID0gbmV3IFBhcmFtZXRlckF3YXJlUHJvcHModGhpcy5wcm9wZXJ0aWVzKTtcbiAgICBjZG5MYXllclByb3BzLmFkZFBhcmFtZXRlcignYXBwYnVja2V0JyxzdG9yYWdlTGF5ZXIuZ2V0UmVzb3VyY2UoJ2FwcGJ1Y2tldCcpKTtcbiAgICAgIG5ldyBDb250ZW50RGVsaXZlcnlMYXllcih0aGlzLCdDb250ZW50RGVsaXZlcnlMYXllcicsY2RuTGF5ZXJQcm9wcyk7XG4gICAgICAqL1xuXG5cbiAgICAvLyBkYXRhYmFzZSBsYXllclxuICAgIGxldCBkYXRhYmFzZUxheWVyID1cbiAgICAgIG5ldyBEYXRhYmFzZUxheWVyKHRoaXMsICdEYXRhYmFzZUxheWVyJywgdGhpcy5wcm9wZXJ0aWVzKTtcbiAgICBcbiAgICAvLyBwcm9jZXNzaW5nIGxheWVyXG4gICAgbGV0IHByb2Nlc3NpbmdMYXllclByb3BzID0gbmV3IFBhcmFtZXRlckF3YXJlUHJvcHModGhpcy5wcm9wZXJ0aWVzKTtcbiAgICAvLyBNSVNTSU5HIFBBUkFNRVRFUiAtIHNpZGUgZWZmZWN0IC0gdW5jb21tZW50IHRoZSBuZXh0IGxpbmVcbiAgICAvLyBwcm9jZXNzaW5nTGF5ZXJQcm9wcy5hZGRQYXJhbWV0ZXIoJ3BhcmFtZXRlci5zZXNzaW9uJywgY29uZmlnTGF5ZXIuZ2V0UmVzb3VyY2UoJ3BhcmFtZXRlci5zZXNzaW9uJykpO1xuICAgICAgcHJvY2Vzc2luZ0xheWVyUHJvcHMuYWRkUGFyYW1ldGVyKCd0YWJsZS5zZXNzaW9uQ29udHJvbCcsIGRhdGFiYXNlTGF5ZXIuZ2V0UmVzb3VyY2UoJ3RhYmxlLnNlc3Npb25Db250cm9sJykpO1xuICAgICAgcHJvY2Vzc2luZ0xheWVyUHJvcHMuYWRkUGFyYW1ldGVyKCd0YWJsZS5zZXNzaW9uVG9wWCcsIGRhdGFiYXNlTGF5ZXIuZ2V0UmVzb3VyY2UoJ3RhYmxlLnNlc3Npb25Ub3BYJykpO1xuICAgICAgcHJvY2Vzc2luZ0xheWVyUHJvcHMuYWRkUGFyYW1ldGVyKCd0YWJsZS5zZXNzaW9uJywgZGF0YWJhc2VMYXllci5nZXRSZXNvdXJjZSgndGFibGUuc2Vzc2lvbicpKTtcbiAgICBsZXQgcHJvY2Vzc2luZ0xheWVyID0gbmV3IFByb2Nlc3NpbmdMYXllcih0aGlzLCAnUHJvY2Vzc2luZ0xheWVyJywgcHJvY2Vzc2luZ0xheWVyUHJvcHMpO1xuXG4gICAgLy8gSW5nZXN0aW9uL2NvbnN1bXB0aW9uIGxheWVyXG4gICAgbGV0IGluZ2VzdGlvbkNvbnN1bXB0aW9uTGF5ZXJQcm9wcyA9IG5ldyBQYXJhbWV0ZXJBd2FyZVByb3BzKHByb2Nlc3NpbmdMYXllclByb3BzKTtcbiAgICBpbmdlc3Rpb25Db25zdW1wdGlvbkxheWVyUHJvcHMuYWRkUGFyYW1ldGVyKCdyYXdidWNrZXRhcm4nLCBzdG9yYWdlTGF5ZXIuZ2V0UmF3RGF0YUJ1Y2tldEFybigpKTtcbiAgICBpbmdlc3Rpb25Db25zdW1wdGlvbkxheWVyUHJvcHMuYWRkUGFyYW1ldGVyKCd1c2VycG9vbCcsc2VjdXJpdHlMYXllci5nZXRVc2VyUG9vbEFybigpKTtcbiAgICBpbmdlc3Rpb25Db25zdW1wdGlvbkxheWVyUHJvcHMuYWRkUGFyYW1ldGVyKCd1c2VycG9vbGlkJywgc2VjdXJpdHlMYXllci5nZXRVc2VyUG9vbElkKCkpO1xuICAgIGluZ2VzdGlvbkNvbnN1bXB0aW9uTGF5ZXJQcm9wcy5hZGRQYXJhbWV0ZXIoJ3RhYmxlLnNlc3Npb24nLGRhdGFiYXNlTGF5ZXIuZ2V0UmVzb3VyY2UoJ3RhYmxlLnNlc3Npb24nKSk7XG4gICAgaW5nZXN0aW9uQ29uc3VtcHRpb25MYXllclByb3BzLmFkZFBhcmFtZXRlcigndGFibGUuc2Vzc2lvbnRvcHgnLGRhdGFiYXNlTGF5ZXIuZ2V0UmVzb3VyY2UoJ3RhYmxlLnNlc3Npb250b3B4JykpO1xuICAgIGluZ2VzdGlvbkNvbnN1bXB0aW9uTGF5ZXJQcm9wcy5hZGRQYXJhbWV0ZXIoJ2xhbWJkYS5hbGxvY2F0ZScscHJvY2Vzc2luZ0xheWVyLmdldEFsbG9jYXRlRnVuY3Rpb25SZWYoKSk7XG4gICAgaW5nZXN0aW9uQ29uc3VtcHRpb25MYXllclByb3BzLmFkZFBhcmFtZXRlcignbGFtYmRhLmRlYWxsb2NhdGUnLHByb2Nlc3NpbmdMYXllci5nZXREZWFsbG9jYXRlRnVuY3Rpb25Bcm4oKSk7XG4gICAgaW5nZXN0aW9uQ29uc3VtcHRpb25MYXllclByb3BzLmFkZFBhcmFtZXRlcignbGFtYmRhLnNjb3JlYm9hcmQnLHByb2Nlc3NpbmdMYXllci5nZXRTY29yZWJvYXJkRnVuY3Rpb25SZWYoKSk7XG4gICAgaW5nZXN0aW9uQ29uc3VtcHRpb25MYXllclByb3BzLmFkZFBhcmFtZXRlcignc2VjdXJpdHkucGxheWVyc3JvbGUnLCBzZWN1cml0eUxheWVyLmdldFJlc291cmNlKCdzZWN1cml0eS5wbGF5ZXJzcm9sZScpKTtcbiAgICBpbmdlc3Rpb25Db25zdW1wdGlvbkxheWVyUHJvcHMuYWRkUGFyYW1ldGVyKCdzZWN1cml0eS5tYW5hZ2Vyc3JvbGUnLCBzZWN1cml0eUxheWVyLmdldFJlc291cmNlKCdzZWN1cml0eS5tYW5hZ2Vyc3JvbGUnKSk7XG4gICAgbmV3IEluZ2VzdGlvbkNvbnN1bXB0aW9uTGF5ZXIodGhpcywgJ0luZ2VzdGlvbkNvbnN1bXB0aW9uTGF5ZXInLGluZ2VzdGlvbkNvbnN1bXB0aW9uTGF5ZXJQcm9wcyk7IFxuICB9XG59Il19